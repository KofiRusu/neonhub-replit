// NeonHub Prisma schema aligned with Postgres + pgvector

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_DATABASE_URL")
  extensions = [vector(schema: "public"), citext(schema: "public")]
}

enum AgentKind {
  COPILOT
  WORKFLOW
  ANALYST
}

enum AgentStatus {
  DRAFT
  ACTIVE
  PAUSED
  DISABLED
}

enum MessageRole {
  system
  user
  assistant
  tool
}

enum ConversationKind {
  support
  campaign
  planning
  ad_hoc
}

enum DatasetKind {
  documents
  faq
  analytics
}

enum TrainStatus {
  queued
  running
  completed
  failed
  cancelled
}

enum ContentKind {
  article
  email
  social_script
  ad_copy
}

enum RunStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
  CANCELLED
}

enum CampaignStatus {
  draft
  scheduled
  active
  paused
  completed
  archived
}

enum ConnectorKind {
  EMAIL
  SMS
  WHATSAPP
  REDDIT
  INSTAGRAM
  FACEBOOK
  X
  YOUTUBE
  TIKTOK
  GOOGLE_ADS
  GOOGLE_SEARCH_CONSOLE
  SHOPIFY
  STRIPE
  SLACK
  DISCORD
  LINKEDIN
}

enum MarketingCampaignType {
  email
  social
  ppc
  content
  seo
  display
  video
  influencer
  event
  other
}

enum MarketingCampaignStatus {
  draft
  scheduled
  active
  paused
  completed
  archived
}

enum MarketingLeadGrade {
  A
  B
  C
  D
  F
}

enum MarketingLeadStatus {
  new
  contacted
  qualified
  nurturing
  converted
  lost
  unqualified
}

enum MarketingTouchpointType {
  page_view
  email_open
  email_click
  ad_impression
  ad_click
  social_view
  social_click
  form_submit
  download
  video_view
  call
  chat
}

enum ConsentStatus {
  granted
  revoked
  denied
  pending
}

enum BudgetAllocationStatus {
  planned
  approved
  executing
  completed
  cancelled
}

model Persona {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  summary   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  keywords  Keyword[]
  calendars EditorialCalendar[]

  @@map("personas")
}

model Keyword {
  id        Int      @id @default(autoincrement())
  term      String   @db.Citext
  intent    String
  priority  Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  personaId Int?
  persona   Persona? @relation(fields: [personaId], references: [id])

  @@unique([term], map: "ux_keyword_term_ci")
  @@index([personaId], map: "ix_keyword_persona")
  @@map("keywords")
}

model EditorialCalendar {
  id        Int      @id @default(autoincrement())
  title     String
  publishAt DateTime
  priority  Int?
  status    String?  @default("planned")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  personaId Int?
  persona   Persona? @relation(fields: [personaId], references: [id])

  @@map("editorial_calendar")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  image         String?
  emailVerified DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts               Account[]
  sessions               Session[]
  contentDrafts          ContentDraft[]
  agentJobs              AgentJob[]
  credentials            Credential[]
  settings               UserSettings?
  subscription           Subscription?
  auditLogs              AuditLog[]
  organizationMembership OrganizationMembership[]
  apiKeys                ApiKey[]                 @relation("ApiKeyCreator")
  conversations          Conversation[]           @relation("ConversationCreator")
  messages               Message[]                @relation("MessageAuthor")
  documents              Document[]               @relation("DocumentOwner")
  tasksCreated           Task[]                   @relation("TaskCreator")
  tasksAssigned          Task[]                   @relation("TaskAssignee")
  feedback               Feedback[]
  connectorAuths         ConnectorAuth[]
  teamMemberships        TeamMember[]
  campaigns              Campaign[]
  personNotes            Note[]                   @relation("NoteAuthor")
  budgetTransactions     BudgetTransaction[]      @relation("BudgetTransactionCreator")

  stripeCustomerId String?   @unique
  isBetaUser       Boolean   @default(false)
  Content          Content[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Organization {
  id        String   @id @default(cuid())
  slug      String   @unique
  name      String
  plan      String   @default("starter")
  settings  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members            OrganizationMembership[]
  roles              OrganizationRole[]
  permissions        OrganizationPermission[]
  apiKeys            ApiKey[]
  brands             Brand[]
  embeddingSpaces    EmbeddingSpace[]
  agents             Agent[]
  datasets           Dataset[]
  modelVersions      ModelVersion[]
  campaigns          Campaign[]
  conversations      Conversation[]
  contentItems       Content[]
  auditLogs          AuditLog[]
  AgentRun           AgentRun[]
  Tool               Tool[]
  Document           Document[]
  InferenceEndpoint  InferenceEndpoint[]
  ContentDraft       ContentDraft[]
  AgentJob           AgentJob[]
  Task               Task[]
  Feedback           Feedback[]
  TeamMember         TeamMember[]
  ConnectorAuth      ConnectorAuth[]
  marketingCampaigns MarketingCampaign[]
  marketingLeads     MarketingLead[]
  marketingMetrics   MarketingMetric[]
  people             Person[]
  identities         Identity[]
  consents           Consent[]
  events             Event[]
  notes              Note[]
  memories           MemEmbedding[]
  topics             Topic[]
  objectives         Objective[]
  budgetProfiles     BudgetProfile[]
  budgetAllocations  BudgetAllocation[]
  budgetLedgers      BudgetLedger[]
  budgetTransactions BudgetTransaction[]
  payments           Payment[]
  payouts            Payout[]
  snippetLibraries   SnippetLibrary[]
  linkGraphEntries   LinkGraph[]
  seoMetrics         SEOMetric[]

  @@map("organizations")
}

model OrganizationRole {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  slug           String
  description    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization    Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  rolePermissions RolePermission[]
  memberships     OrganizationMembership[]

  @@unique([organizationId, slug])
  @@map("organization_roles")
}

model OrganizationPermission {
  id             String   @id @default(cuid())
  organizationId String
  key            String
  description    String?
  createdAt      DateTime @default(now())

  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  rolePermissions RolePermission[]

  @@unique([organizationId, key])
  @@map("organization_permissions")
}

model RolePermission {
  roleId       String
  permissionId String

  role       OrganizationRole       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission OrganizationPermission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model OrganizationMembership {
  id             String   @id @default(cuid())
  organizationId String
  userId         String
  roleId         String?
  status         String   @default("active")
  invitedById    String?
  joinedAt       DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  role         OrganizationRole? @relation(fields: [roleId], references: [id], onDelete: SetNull)

  @@unique([organizationId, userId])
  @@map("organization_members")
}

model ApiKey {
  id             String    @id @default(cuid())
  organizationId String
  createdById    String
  name           String
  tokenHash      String
  scopes         String[]  @default([])
  lastUsedAt     DateTime?
  expiresAt      DateTime?
  revokedAt      DateTime?
  createdAt      DateTime  @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  creator      User         @relation("ApiKeyCreator", fields: [createdById], references: [id], onDelete: Cascade)

  @@unique([organizationId, tokenHash])
  @@unique([createdById, tokenHash])
  @@map("api_keys")
}

model EmbeddingSpace {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  provider       String
  model          String
  dimension      Int
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  brandVoices  BrandVoice[]
  datasets     Dataset[]
  chunks       Chunk[]
  Document     Document[]

  @@unique([organizationId, name])
  @@map("embedding_spaces")
}

model Brand {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  slug           String
  description    String?
  mainColor      String?
  slogan         String?
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization       Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  brandVoices        BrandVoice[]
  assets             BrandAsset[]
  marketingCampaigns MarketingCampaign[]
  budgetProfiles     BudgetProfile[]
  snippetLibraries   SnippetLibrary[]

  @@unique([organizationId, slug])
  @@map("brands")
}

model BrandVoice {
  id               String                 @id @default(cuid())
  brandId          String
  embeddingSpaceId String
  promptTemplate   String                 @db.Text
  styleRulesJson   Json
  embedding        Unsupported("vector")?
  metrics          Json?
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt

  brand          Brand          @relation(fields: [brandId], references: [id], onDelete: Cascade)
  embeddingSpace EmbeddingSpace @relation(fields: [embeddingSpaceId], references: [id], onDelete: Cascade)

  @@map("brand_voices")
}

model BrandAsset {
  id        String   @id @default(cuid())
  brandId   String
  kind      String
  name      String
  url       String?
  metadata  Json?
  createdAt DateTime @default(now())

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@map("brand_assets")
}

model Agent {
  id             String      @id @default(cuid())
  organizationId String
  name           String
  slug           String
  kind           AgentKind
  status         AgentStatus @default(ACTIVE)
  description    String?
  version        String?
  config         Json?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  capabilities AgentCapability[]
  configs      AgentConfig[]
  runs         AgentRun[]
  tools        Tool[]

  @@unique([organizationId, slug])
  @@map("agents")
}

model AgentCapability {
  id        String   @id @default(cuid())
  agentId   String
  name      String
  config    Json?
  createdAt DateTime @default(now())

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@map("agent_capabilities")
}

model AgentConfig {
  id        String   @id @default(cuid())
  agentId   String
  key       String
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([agentId, key])
  @@map("agent_configs")
}

model AgentRun {
  id             String     @id @default(cuid())
  agentId        String
  organizationId String
  datasetId      String?
  status         RunStatus  @default(PENDING)
  objective      String?
  input          Json
  output         Json?
  metrics        Json?
  meta           Json?
  inputHash      String?
  errorMessage   String?
  startedAt      DateTime   @default(now())
  completedAt    DateTime?
  durationMs     Int?

  agent          Agent            @relation(fields: [agentId], references: [id], onDelete: Cascade)
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  dataset        Dataset?         @relation(fields: [datasetId], references: [id], onDelete: SetNull)
  toolExecutions ToolExecution[]
  runMetrics     AgentRunMetric[]
  steps          RunStep[]

  @@index([agentId, startedAt])
  @@index([organizationId, status, startedAt])
  @@map("agent_runs")
}

model AgentRunMetric {
  id         String @id @default(cuid())
  agentRunId String
  name       String
  value      Float?
  metadata   Json?

  agentRun AgentRun @relation(fields: [agentRunId], references: [id], onDelete: Cascade)

  @@map("agent_run_metrics")
}

model Tool {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  slug           String
  description    String?
  inputSchema    Json?
  outputSchema   Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  executions   ToolExecution[]
  Agent        Agent?          @relation(fields: [agentId], references: [id])
  agentId      String?

  @@unique([organizationId, slug])
  @@map("tools")
}

model ToolExecution {
  id          String    @id @default(cuid())
  toolId      String
  agentRunId  String?
  status      String    @default("queued")
  input       Json?
  output      Json?
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  metadata    Json?

  tool     Tool      @relation(fields: [toolId], references: [id], onDelete: Cascade)
  agentRun AgentRun? @relation(fields: [agentRunId], references: [id], onDelete: SetNull)

  @@map("tool_executions")
}

model RunStep {
  id          String     @id @default(cuid())
  runId       String
  name        String
  status      RunStatus  @default(PENDING)
  payload     Json?
  result      Json?
  error       String?
  startedAt   DateTime?  @default(now())
  completedAt DateTime?
  durationMs  Int?

  run AgentRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId, status])
  @@map("run_steps")
}

model Conversation {
  id             String           @id @default(cuid())
  organizationId String
  kind           ConversationKind @default(support)
  status         String           @default("active")
  title          String?
  createdById    String?
  metadata       Json?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy    User?        @relation("ConversationCreator", fields: [createdById], references: [id], onDelete: SetNull)
  messages     Message[]

  @@index([organizationId, createdAt])
  @@map("conversations")
}

model Message {
  id             String                 @id @default(cuid())
  conversationId String
  authorId       String?
  role           MessageRole
  contentJson    Json
  embedding      Unsupported("vector")?
  metadata       Json?
  createdAt      DateTime               @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  author       User?        @relation("MessageAuthor", fields: [authorId], references: [id], onDelete: SetNull)

  @@index([conversationId, createdAt])
  @@index([role, createdAt])
  @@map("messages")
}

model Dataset {
  id               String      @id @default(cuid())
  organizationId   String
  embeddingSpaceId String?
  name             String
  slug             String
  kind             DatasetKind
  description      String?
  source           String?
  metadata         Json?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  embeddingSpace EmbeddingSpace? @relation(fields: [embeddingSpaceId], references: [id], onDelete: SetNull)
  documents      Document[]
  chunks         Chunk[]
  AgentRun       AgentRun[]

  @@unique([organizationId, slug])
  @@map("datasets")
}

model Document {
  id               String   @id @default(cuid())
  datasetId        String?
  organizationId   String
  ownerId          String
  embeddingSpaceId String?
  title            String
  content          String   @db.Text
  status           String   @default("draft")
  metadata         Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  dataset        Dataset?        @relation(fields: [datasetId], references: [id], onDelete: SetNull)
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  owner          User            @relation("DocumentOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  embeddingSpace EmbeddingSpace? @relation(fields: [embeddingSpaceId], references: [id], onDelete: SetNull)
  chunks         Chunk[]

  @@map("documents")
}

model Chunk {
  id               String                 @id @default(cuid())
  datasetId        String
  documentId       String
  embeddingSpaceId String
  idx              Int
  text             String                 @db.Text
  embedding        Unsupported("vector")?
  metadata         Json?
  createdAt        DateTime               @default(now())

  dataset        Dataset        @relation(fields: [datasetId], references: [id], onDelete: Cascade)
  document       Document       @relation(fields: [documentId], references: [id], onDelete: Cascade)
  embeddingSpace EmbeddingSpace @relation(fields: [embeddingSpaceId], references: [id], onDelete: Cascade)

  @@unique([datasetId, idx])
  @@index([embeddingSpaceId])
  @@map("chunks")
}

model ModelVersion {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  provider       String
  version        String
  metadata       Json?
  createdAt      DateTime @default(now())

  organization Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  trainingJobs TrainingJob[]
  endpoints    InferenceEndpoint[]

  @@map("model_versions")
}

model TrainingJob {
  id             String      @id @default(cuid())
  modelVersionId String
  status         TrainStatus @default(queued)
  config         Json
  metrics        Json?
  startedAt      DateTime    @default(now())
  completedAt    DateTime?

  modelVersion ModelVersion @relation(fields: [modelVersionId], references: [id], onDelete: Cascade)

  @@map("training_jobs")
}

model InferenceEndpoint {
  id             String   @id @default(cuid())
  organizationId String
  modelVersionId String?
  name           String
  slug           String
  status         String   @default("draft")
  config         Json?
  createdAt      DateTime @default(now())

  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  modelVersion ModelVersion? @relation(fields: [modelVersionId], references: [id], onDelete: SetNull)

  @@unique([organizationId, slug])
  @@map("inference_endpoints")
}

model Content {
  id             String      @id @default(cuid())
  organizationId String
  authorId       String?
  kind           ContentKind
  status         String      @default("draft")
  title          String?
  body           String?     @db.Text
  metadata       Json?
  publishedAt    DateTime?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  author       User?        @relation(fields: [authorId], references: [id], onDelete: SetNull)
  outgoingLinks LinkGraph[] @relation("LinkGraphSource")
  incomingLinks LinkGraph[] @relation("LinkGraphTarget")
  seoMetrics    SEOMetric[]

  @@map("content")
}

model LinkGraph {
  id               String   @id @default(cuid())
  organizationId   String
  sourceContentId  String
  targetContentId  String
  anchorText       String
  similarity       Float?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  source       Content       @relation("LinkGraphSource", fields: [sourceContentId], references: [id], onDelete: Cascade)
  target       Content       @relation("LinkGraphTarget", fields: [targetContentId], references: [id], onDelete: Cascade)

  @@unique([sourceContentId, targetContentId, anchorText])
  @@index([organizationId])
  @@map("link_graph")
}

model SEOMetric {
  id             String   @id @default(cuid())
  organizationId String
  contentId      String?
  url            String
  keyword        String
  impressions    Int
  clicks         Int
  ctr            Float
  avgPosition    Float
  date           DateTime
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  content      Content?     @relation(fields: [contentId], references: [id], onDelete: SetNull)

  @@index([url, date])
  @@index([keyword, date])
  @@index([organizationId, date])
  @@unique([organizationId, url, keyword, date])
  @@map("seo_metrics")
}

model Campaign {
  id             String         @id @default(cuid())
  organizationId String
  ownerId        String
  name           String
  status         CampaignStatus @default(draft)
  type           String
  config         Json?
  schedule       Json?
  budget         Json?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  organization       Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  owner              User                @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  metrics            CampaignMetric[]
  emailSequences     EmailSequence[]
  socialPosts        SocialPost[]
  abTests            ABTest[]
  budgetTransactions BudgetTransaction[]

  @@index([organizationId, status])
  @@map("campaigns")
}

model CampaignMetric {
  id         String   @id @default(cuid())
  campaignId String
  kind       String
  value      Float?
  payload    Json?
  timestamp  DateTime @default(now())

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId, kind, timestamp])
  @@map("campaign_metrics")
}

model MarketingCampaign {
  id             String                  @id @default(cuid())
  organizationId String
  brandId        String?
  name           String
  description    String?
  type           MarketingCampaignType
  status         MarketingCampaignStatus @default(draft)
  budget         Float?
  spent          Float                   @default(0)
  startDate      DateTime
  endDate        DateTime?
  impressions    Int                     @default(0)
  clicks         Int                     @default(0)
  conversions    Int                     @default(0)
  revenue        Float                   @default(0)
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt

  organization        Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  brand               Brand?                @relation(fields: [brandId], references: [id])
  leads               MarketingLead[]
  touchpoints         MarketingTouchpoint[]
  consents            Consent[]
  events              Event[]
  budgetAllocations   BudgetAllocation[]
  budgetLedgerEntries BudgetLedger[]

  @@index([organizationId, status])
  @@index([startDate, endDate])
  @@map("marketing_campaigns")
}

model MarketingLead {
  id              String              @id @default(cuid())
  organizationId  String
  email           String
  firstName       String?
  lastName        String?
  company         String?
  phone           String?
  source          String
  medium          String?
  campaign        String?
  campaignId      String?
  utmParams       Json?
  score           Int                 @default(0)
  grade           MarketingLeadGrade?
  status          MarketingLeadStatus @default(new)
  firstTouch      DateTime            @default(now())
  lastTouch       DateTime            @default(now())
  touchCount      Int                 @default(1)
  pageViews       Int                 @default(0)
  engagementScore Int                 @default(0)
  convertedAt     DateTime?
  convertedValue  Float?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  organization      Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  marketingCampaign MarketingCampaign?    @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  touchpoints       MarketingTouchpoint[]

  @@index([organizationId, status])
  @@index([email])
  @@index([source, medium])
  @@index([score])
  @@map("marketing_leads")
}

model MarketingTouchpoint {
  id                String                  @id @default(cuid())
  leadId            String
  campaignId        String?
  type              MarketingTouchpointType
  channel           String
  url               String?
  referrer          String?
  device            String?
  location          String?
  sessionId         String?
  eventData         Json?
  attributionWeight Float                   @default(0)
  timestamp         DateTime                @default(now())

  lead     MarketingLead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  campaign MarketingCampaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)

  @@index([leadId, timestamp])
  @@index([campaignId])
  @@index([channel, type])
  @@map("marketing_touchpoints")
}

model MarketingMetric {
  id               String   @id @default(cuid())
  organizationId   String
  date             DateTime
  impressions      Int      @default(0)
  clicks           Int      @default(0)
  conversions      Int      @default(0)
  revenue          Float    @default(0)
  cost             Float    @default(0)
  leadsGenerated   Int      @default(0)
  leadsCost        Float    @default(0)
  channelBreakdown Json?
  createdAt        DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, date])
  @@index([date])
  @@map("marketing_metrics")
}

model Person {
  id             String    @id @default(cuid())
  organizationId String
  externalId     String?
  displayName    String?
  primaryEmail   String?
  primaryPhone   String?
  primaryHandle  String?
  locale         String?
  timezone       String?
  personaTags    String[]  @default([])
  attributes     Json?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  lastSeenAt     DateTime?

  organization  Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  identities    Identity[]
  consents      Consent[]
  events        Event[]
  notes         Note[]
  memories      MemEmbedding[]
  topics        Topic[]
  objectives    Objective[]
  ledgerEntries BudgetLedger[]

  @@unique([organizationId, externalId])
  @@index([organizationId, primaryEmail])
  @@index([organizationId, primaryPhone])
  @@index([organizationId, lastSeenAt])
  @@map("people")
}

model Identity {
  id             String    @id @default(cuid())
  personId       String
  organizationId String
  type           String
  value          String    @db.Citext
  channel        String?
  verifiedAt     DateTime?
  source         String?
  metadata       Json?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  person       Person       @relation(fields: [personId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, type, value])
  @@index([personId, type])
  @@map("person_identities")
}

model Consent {
  id             String        @id @default(cuid())
  personId       String
  organizationId String
  campaignId     String?
  channel        String
  status         ConsentStatus @default(granted)
  source         String?
  collectedAt    DateTime      @default(now())
  expiresAt      DateTime?
  evidence       Json?
  metadata       Json?
  updatedAt      DateTime      @updatedAt

  person       Person             @relation(fields: [personId], references: [id], onDelete: Cascade)
  organization Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  campaign     MarketingCampaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)

  @@index([personId, channel])
  @@index([organizationId, channel])
  @@map("person_consents")
}

model Event {
  id             String   @id @default(cuid())
  organizationId String
  personId       String
  campaignId     String?
  objectiveId    String?
  channel        String
  type           String
  source         String?
  providerId     String?
  topic          String?
  intent         String?
  sentiment      String?
  payload        Json?
  metadata       Json?
  occurredAt     DateTime @default(now())
  createdAt      DateTime @default(now())

  person       Person             @relation(fields: [personId], references: [id], onDelete: Cascade)
  organization Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  campaign     MarketingCampaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  objective    Objective?         @relation(fields: [objectiveId], references: [id], onDelete: SetNull)
  memories     MemEmbedding[]

  @@index([organizationId, occurredAt])
  @@index([personId, occurredAt])
  @@index([organizationId, channel, type])
  @@map("events")
}

model Note {
  id             String   @id @default(cuid())
  organizationId String
  personId       String
  authorId       String?
  body           String   @db.Text
  tags           String[] @default([])
  visibility     String   @default("internal")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  person       Person       @relation(fields: [personId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  author       User?        @relation("NoteAuthor", fields: [authorId], references: [id], onDelete: SetNull)

  @@index([personId, createdAt])
  @@index([organizationId])
  @@map("person_notes")
}

model MemEmbedding {
  id             String                 @id @default(cuid())
  organizationId String
  personId       String
  sourceEventId  String?
  label          String?
  embedding      Unsupported("vector")?
  metadata       Json?
  createdAt      DateTime               @default(now())
  expiresAt      DateTime?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  person       Person       @relation(fields: [personId], references: [id], onDelete: Cascade)
  sourceEvent  Event?       @relation(fields: [sourceEventId], references: [id], onDelete: SetNull)

  @@index([personId, createdAt])
  @@index([organizationId])
  @@map("mem_embeddings")
}

model Topic {
  id             String   @id @default(cuid())
  organizationId String
  personId       String
  name           String
  weight         Float    @default(0)
  trend          Float?   @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  person       Person       @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@unique([personId, name])
  @@index([organizationId, name])
  @@map("person_topics")
}

model Objective {
  id             String    @id @default(cuid())
  organizationId String
  personId       String
  title          String
  description    String?
  status         String    @default("active")
  priority       Int       @default(0)
  successMetric  String?
  targetValue    Float?
  dueAt          DateTime?
  metadata       Json?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  person       Person             @relation(fields: [personId], references: [id], onDelete: Cascade)
  events       Event[]
  allocations  BudgetAllocation[]

  @@index([organizationId, status])
  @@index([personId, status])
  @@map("person_objectives")
}

model BudgetProfile {
  id             String   @id @default(cuid())
  organizationId String
  brandId        String?
  name           String
  currency       String   @default("usd")
  totalBudget    Float?
  reserved       Float    @default(0)
  spent          Float    @default(0)
  constraints    Json?
  settings       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization  Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  brand         Brand?             @relation(fields: [brandId], references: [id], onDelete: SetNull)
  allocations   BudgetAllocation[]
  ledgerEntries BudgetLedger[]
  payments      Payment[]
  payouts       Payout[]

  @@unique([organizationId, name])
  @@index([brandId])
  @@map("budget_profiles")
}

model BudgetAllocation {
  id              String                 @id @default(cuid())
  organizationId  String
  budgetProfileId String
  campaignId      String?
  objectiveId     String?
  channel         String
  amount          Float
  currency        String                 @default("usd")
  windowStart     DateTime?
  windowEnd       DateTime?
  status          BudgetAllocationStatus @default(planned)
  metadata        Json?
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt

  organization  Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  budgetProfile BudgetProfile      @relation(fields: [budgetProfileId], references: [id], onDelete: Cascade)
  campaign      MarketingCampaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  objective     Objective?         @relation(fields: [objectiveId], references: [id], onDelete: SetNull)
  ledgerEntries BudgetLedger[]

  @@index([organizationId, status])
  @@index([budgetProfileId])
  @@index([campaignId])
  @@map("budget_allocations")
}

model BudgetLedger {
  id              String   @id @default(cuid())
  organizationId  String
  budgetProfileId String
  allocationId    String?
  campaignId      String?
  personId        String?
  entryType       String
  amount          Float
  currency        String   @default("usd")
  occurredAt      DateTime @default(now())
  metadata        Json?

  organization  Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  budgetProfile BudgetProfile      @relation(fields: [budgetProfileId], references: [id], onDelete: Cascade)
  allocation    BudgetAllocation?  @relation(fields: [allocationId], references: [id], onDelete: SetNull)
  campaign      MarketingCampaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  person        Person?            @relation(fields: [personId], references: [id], onDelete: SetNull)

  @@index([organizationId, occurredAt])
  @@index([budgetProfileId])
  @@index([allocationId])
  @@map("budget_ledger")
}

model Payment {
  id                    String   @id @default(cuid())
  organizationId        String
  budgetProfileId       String?
  stripePaymentIntentId String   @unique
  status                String
  amount                Float
  currency              String   @default("usd")
  customerId            String?
  metadata              Json?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  organization  Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  budgetProfile BudgetProfile? @relation(fields: [budgetProfileId], references: [id], onDelete: SetNull)

  @@index([organizationId, status])
  @@map("payments")
}

model Payout {
  id               String    @id @default(cuid())
  organizationId   String
  budgetProfileId  String?
  partnerId        String
  stripeTransferId String?
  status           String
  amount           Float
  currency         String    @default("usd")
  metadata         Json?
  createdAt        DateTime  @default(now())
  processedAt      DateTime?

  organization  Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  budgetProfile BudgetProfile? @relation(fields: [budgetProfileId], references: [id], onDelete: SetNull)

  @@index([organizationId, status])
  @@map("payouts")
}

model SnippetLibrary {
  id             String    @id @default(cuid())
  organizationId String
  brandId        String?
  channel        String
  name           String
  content        String    @db.Text
  tone           String?
  useCases       String[]  @default([])
  winRate        Float?
  usageCount     Int       @default(0)
  lastWonAt      DateTime?
  metadata       Json?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  brand        Brand?       @relation(fields: [brandId], references: [id], onDelete: SetNull)

  @@unique([organizationId, name, channel])
  @@index([organizationId, channel])
  @@index([brandId])
  @@map("snippet_library")
}

model EmailSequence {
  id           String    @id @default(cuid())
  campaignId   String
  subject      String
  body         String    @db.Text
  variant      String?
  scheduledFor DateTime?
  sentAt       DateTime?
  metrics      Json?
  createdAt    DateTime  @default(now())

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId, scheduledFor])
  @@map("email_sequences")
}

model SocialPost {
  id           String    @id @default(cuid())
  campaignId   String
  platform     String
  content      String    @db.Text
  mediaUrls    Json?
  variant      String?
  scheduledFor DateTime?
  publishedAt  DateTime?
  externalId   String?
  metrics      Json?
  createdAt    DateTime  @default(now())

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId, platform, scheduledFor])
  @@map("social_posts")
}

model ABTest {
  id          String    @id @default(cuid())
  campaignId  String
  name        String
  variants    Json
  winner      String?
  metrics     Json
  startedAt   DateTime  @default(now())
  completedAt DateTime?

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@map("ab_tests")
}

model ContentDraft {
  id             String   @id @default(cuid())
  organizationId String?
  title          String
  topic          String
  body           String   @db.Text
  tone           String   @default("professional")
  audience       String?
  status         String   @default("draft")
  createdById    String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  createdBy    User          @relation(fields: [createdById], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  @@index([createdById, status])
  @@index([createdAt])
  @@map("content_drafts")
}

model AgentJob {
  id             String   @id @default(cuid())
  organizationId String?
  agent          String
  input          Json
  output         Json?
  status         String   @default("queued")
  error          String?  @db.Text
  metrics        Json?
  createdById    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  createdBy    User?         @relation(fields: [createdById], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  @@index([agent])
  @@index([status])
  @@index([createdAt])
  @@map("agent_jobs")
}

model MetricEvent {
  id        String   @id @default(cuid())
  type      String
  meta      Json
  createdAt DateTime @default(now())

  @@index([type])
  @@index([createdAt])
  @@map("metric_events")
}

model Credential {
  id           String    @id @default(cuid())
  userId       String
  provider     String
  accountId    String?
  accessToken  String?   @db.Text
  refreshToken String?   @db.Text
  accessSecret String?   @db.Text
  scope        String?
  tokenType    String?
  expiresAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  lastUsedAt   DateTime?
  status       String    @default("active")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider, accountId])
  @@index([userId, provider])
  @@map("credentials")
}

model UserSettings {
  id                    String   @id @default(cuid())
  userId                String   @unique
  brandVoice            Json?
  emailNotifications    Boolean  @default(true)
  pushNotifications     Boolean  @default(false)
  notificationFrequency String   @default("realtime")
  timezone              String   @default("UTC")
  locale                String   @default("en-US")
  dateFormat            String   @default("MM/DD/YYYY")
  dataRetention         Int      @default(90)
  allowAnalytics        Boolean  @default(true)
  allowPersonalization  Boolean  @default(true)
  apiRateLimit          Int      @default(1000)
  webhookUrl            String?
  webhookSecret         String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

model Subscription {
  id                   String    @id @default(cuid())
  userId               String    @unique
  stripeCustomerId     String    @unique
  stripeSubscriptionId String    @unique
  stripePriceId        String
  stripeProductId      String
  plan                 String
  status               String
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean   @default(false)
  canceledAt           DateTime?
  campaignsUsed        Int       @default(0)
  emailsSent           Int       @default(0)
  socialPosts          Int       @default(0)
  agentCalls           Int       @default(0)
  campaignLimit        Int       @default(5)
  emailLimit           Int       @default(1000)
  socialLimit          Int       @default(100)
  agentCallLimit       Int       @default(100)
  trialEndsAt          DateTime?
  metadata             Json?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoices     Invoice[]
  usageRecords UsageRecord[]

  @@map("subscriptions")
}

model Invoice {
  id                    String    @id @default(cuid())
  subscriptionId        String
  stripeInvoiceId       String    @unique
  stripePaymentIntentId String?
  amountDue             Int
  amountPaid            Int       @default(0)
  currency              String    @default("usd")
  status                String
  invoicePdf            String?
  hostedInvoiceUrl      String?
  dueDate               DateTime?
  paidAt                DateTime?
  metadata              Json?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId, status])
  @@map("invoices")
}

model UsageRecord {
  id             String   @id @default(cuid())
  subscriptionId String
  resourceType   String
  resourceId     String?
  quantity       Int      @default(1)
  cost           Int?
  timestamp      DateTime @default(now())
  metadata       Json?

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId, resourceType, timestamp])
  @@map("usage_records")
}

model AuditLog {
  id             String   @id @default(cuid())
  organizationId String?
  userId         String?
  actorType      String?
  action         String
  resourceId     String?
  resourceType   String?
  requestHash    String?
  metadata       Json?
  ip             String?
  createdAt      DateTime @default(now())

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  user         User?         @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([organizationId, createdAt])
  @@index([userId, createdAt])
  @@index([action])
  @@map("audit_logs")
}

model Task {
  id             String    @id @default(cuid())
  organizationId String?
  title          String
  description    String?   @db.Text
  status         String    @default("todo")
  priority       String    @default("medium")
  createdById    String
  assigneeId     String?
  dueDate        DateTime?
  completedAt    DateTime?
  tags           String[]
  metadata       Json?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  createdBy    User          @relation("TaskCreator", fields: [createdById], references: [id], onDelete: Cascade)
  assignee     User?         @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)

  @@index([createdById, status])
  @@index([assigneeId, status])
  @@index([dueDate])
  @@map("tasks")
}

model Feedback {
  id             String    @id @default(cuid())
  organizationId String?
  type           String
  category       String?
  title          String
  description    String    @db.Text
  rating         Int?
  status         String    @default("open")
  userId         String
  metadata       Json?
  response       String?   @db.Text
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  resolvedAt     DateTime?

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([type, status])
  @@index([createdAt])
  @@map("feedback")
}

model TeamMember {
  id             String    @id @default(cuid())
  organizationId String?
  userId         String
  role           String    @default("Member")
  department     String?
  status         String    @default("active")
  invitedBy      String?
  invitedAt      DateTime?
  joinedAt       DateTime  @default(now())
  metadata       Json?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([role, status])
  @@map("team_members")
}

model Connector {
  id          String        @id @default(cuid())
  name        String        @unique
  displayName String
  description String        @db.Text
  category    ConnectorKind
  iconUrl     String?
  websiteUrl  String?
  authType    String
  authConfig  Json
  isEnabled   Boolean       @default(true)
  isVerified  Boolean       @default(false)
  triggers    Json
  actions     Json
  metadata    Json?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  connectorAuths ConnectorAuth[]

  @@map("connectors")
}

model ConnectorAuth {
  id             String         @id @default(cuid())
  userId         String
  connectorId    String?
  connectorKind  String
  organizationId String?
  accountId      String?
  accountName    String?
  accessToken    String?        @db.Text
  refreshToken   String?        @db.Text
  apiKey         String?        @db.Text
  apiSecret      String?        @db.Text
  scopes         String[]       @default([])
  scope          String?
  tokenType      String?
  expiresAt      DateTime?
  status         String         @default("active")
  lastUsedAt     DateTime?
  lastError      String?        @db.Text
  metadata       Json?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  connector      Connector?      @relation(fields: [connectorId], references: [id], onDelete: SetNull)
  organization   Organization?   @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  triggerConfigs TriggerConfig[]
  actionConfigs  ActionConfig[]

  @@unique([userId, connectorKind], name: "userId_connectorKind")
  @@unique([userId, connectorId, accountId], name: "userId_connectorId_accountId")
  @@index([connectorKind])
  @@map("connector_auths")
}

model TriggerConfig {
  id              String    @id @default(cuid())
  connectorAuthId String
  name            String
  triggerType     String
  config          Json
  isActive        Boolean   @default(true)
  lastTriggeredAt DateTime?
  triggerCount    Int       @default(0)
  metadata        Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  connectorAuth ConnectorAuth @relation(fields: [connectorAuthId], references: [id], onDelete: Cascade)

  @@index([connectorAuthId, isActive])
  @@map("trigger_configs")
}

model ActionConfig {
  id              String    @id @default(cuid())
  connectorAuthId String
  name            String
  actionType      String
  config          Json
  isActive        Boolean   @default(true)
  lastExecutedAt  DateTime?
  executionCount  Int       @default(0)
  metadata        Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  connectorAuth ConnectorAuth @relation(fields: [connectorAuthId], references: [id], onDelete: Cascade)

  @@index([connectorAuthId, isActive])
  @@map("action_configs")
}

enum BudgetTransactionType {
  allocate
  spend
  reserve
  refund
  adjustment
}

model BudgetTransaction {
  id             String                @id @default(cuid())
  campaignId     String
  organizationId String
  type           BudgetTransactionType
  amount         Float
  currency       String                @default("USD")
  channel        String?
  description    String?
  metadata       Json?
  balanceBefore  Float
  balanceAfter   Float
  createdAt      DateTime              @default(now())
  createdBy      String?

  campaign     Campaign     @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  creator      User?        @relation("BudgetTransactionCreator", fields: [createdBy], references: [id], onDelete: SetNull)

  @@index([campaignId])
  @@index([organizationId])
  @@index([type])
  @@index([createdAt])
  @@map("budget_transactions")
}
