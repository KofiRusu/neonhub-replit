name: Auto Sync from Sibling Repos

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch: {}
  push:
    paths: [ "scripts/auto-sync/**", ".github/workflows/auto-sync-from-siblings.yml" ]

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      SOURCE_PAT: ${{ secrets.SOURCE_PAT || secrets.GITHUB_TOKEN }}
      NODE_OPTIONS: "--max-old-space-size=4096"
    steps:
      - name: Skip if SOURCE_PAT not configured and repos likely private
        run: |
          if [ -z "${SOURCE_PAT}" ] || [ "${SOURCE_PAT}" == "${GITHUB_TOKEN}" ]; then
            echo "⚠️ SOURCE_PAT not set or using default GITHUB_TOKEN; private source repos may fail."
            echo "ℹ️ Set SOURCE_PAT secret to enable cross-repo access. Skipping gracefully."
            exit 0
          fi
        shell: bash
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect package manager
        id: pkg_manager
        run: |
          if [ -f pnpm-lock.yaml ]; then
            echo "manager=pnpm" >> $GITHUB_OUTPUT
          else
            echo "manager=npm" >> $GITHUB_OUTPUT
          fi

      - name: Enable pnpm for caching
        if: steps.pkg_manager.outputs.manager == 'pnpm'
        run: |
          corepack enable
          corepack prepare pnpm@9 --activate

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install pnpm
        if: steps.pkg_manager.outputs.manager == 'pnpm'
        run: |
          corepack enable
          corepack prepare pnpm@9 --activate
          pnpm --version

      - name: Install deps
        run: |
          corepack enable || true
          if command -v pnpm >/dev/null 2>&1 && [ -f pnpm-lock.yaml ]; then
            pnpm install --frozen-lockfile || pnpm install --no-frozen-lockfile
          else
            npm ci
          fi

      - name: Ensure labels exist
        run: |
          labels=(
            "auto-sync:#0366d6:Automated sync PRs"
            "risk:low:#2cbe4e:Low risk changes"
            "risk:medium:#fbca04:Medium risk changes"
            "risk:high:#d93f0b:High risk changes"
          )
          
          for label in "${labels[@]}"; do
            IFS=':' read -r name color desc <<< "$label"
            gh label list --limit 100 | grep -q "^${name}" || \
              gh label create "${name}" -c "${color}" -d "${desc}" || true
          done

      - name: Validate auto-sync script
        run: |
          if [ ! -f scripts/auto-sync/index.ts ]; then
            echo "⚠️ Auto-sync script not found at scripts/auto-sync/index.ts"
            echo "ℹ️ Skipping auto-sync - script needs to be created first"
            exit 0
          fi
          if [ ! -f scripts/auto-sync/config.json ]; then
            echo "⚠️ Auto-sync config not found at scripts/auto-sync/config.json"
            echo "ℹ️ Skipping auto-sync - config needs to be created first"
            exit 0
          fi
          npx --yes tsx@4 --check scripts/auto-sync/index.ts || {
            echo "❌ Auto-sync script has TypeScript errors"
            exit 1
          }
          echo "✅ Auto-sync script validated"

      - name: Run Auto Sync
        run: |
          if [ ! -f scripts/auto-sync/run-ci.sh ]; then
            echo "⚠️ Auto-sync runner not found at scripts/auto-sync/run-ci.sh"
            echo "ℹ️ Skipping execution - create script to enable auto-sync"
            exit 0
          fi
          chmod +x scripts/auto-sync/run-ci.sh || true
          if [ -x scripts/auto-sync/run-ci.sh ]; then
            ./scripts/auto-sync/run-ci.sh
          else
            echo "⚠️ run-ci.sh is not executable, attempting to run with shell"
            bash scripts/auto-sync/run-ci.sh
          fi
