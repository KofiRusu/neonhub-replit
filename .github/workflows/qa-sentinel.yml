name: QA Sentinel Validation

on:
  pull_request:
    branches: [ main, develop, v5.* ]
    paths:
      - 'core/**'
      - 'apps/**'
      - 'modules/**'
      - '!docs/**'
      - '!*.md'
  push:
    branches: [ main, v5.* ]
    paths:
      - 'core/**'
      - 'apps/**'
      - 'modules/**'
      - '!docs/**'
      - '!*.md'
  schedule:
    # Run daily QA validation
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      validation_type:
        description: 'Type of validation to run'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - benchmark
          - anomaly
          - scheduled

jobs:
  qa-sentinel-validation:
    runs-on: ubuntu-latest
    environment: production

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build QA Sentinel
        run: |
          cd core/qa-sentinel
          npm run build

      - name: Setup test database
        run: |
          npm run db:migrate
          npm run db:seed:test

      - name: Run QA Sentinel validation
        id: qa-validation
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            ./scripts/ci-cd/qa-sentinel-trigger.sh validate "${{ github.run_id }}" "${{ github.event.number }}"
          elif [ "${{ github.event_name }}" = "schedule" ] || [ "${{ inputs.validation_type }}" = "scheduled" ]; then
            ./scripts/ci-cd/qa-sentinel-trigger.sh scheduled
          elif [ "${{ inputs.validation_type }}" = "benchmark" ]; then
            ./scripts/ci-cd/qa-sentinel-trigger.sh benchmark "${{ github.run_id }}"
          elif [ "${{ inputs.validation_type }}" = "anomaly" ]; then
            ./scripts/ci-cd/qa-sentinel-trigger.sh anomaly
          else
            ./scripts/ci-cd/qa-sentinel-trigger.sh full "${{ github.run_id }}"
          fi
        env:
          NODE_ENV: test
          CI: true
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/neonhub_test
          REDIS_URL: redis://localhost:6379
          QA_SENTINEL_ENABLED: true

      - name: Generate QA report
        if: always()
        run: |
          ./scripts/ci-cd/qa-sentinel-trigger.sh report

      - name: Upload QA artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qa-sentinel-results-${{ github.run_id }}
          path: |
            logs/qa-sentinel-*.log
            reports/qa-sentinel-*.json
            core/qa-sentinel/coverage/
          retention-days: 30

      - name: Comment PR with QA results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Find the latest QA report
            const reportsDir = 'reports';
            const reportFiles = fs.readdirSync(reportsDir)
              .filter(file => file.startsWith('qa-sentinel-report-'))
              .sort()
              .reverse();

            if (reportFiles.length > 0) {
              const reportPath = path.join(reportsDir, reportFiles[0]);
              const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));

              const comment = `
            ## ü§ñ QA Sentinel Validation Results

            **Status:** ${report.status === 'success' ? '‚úÖ Passed' : '‚ùå Failed'}

            ### Test Results
            - **Total Tests:** ${report.totalTests}
            - **Passed:** ${report.passedTests}
            - **Failed:** ${report.failedTests}
            - **Coverage:** ${report.coverage}%

            ### Quality Metrics
            - **Performance Score:** ${report.performanceScore}/100
            - **Anomalies Detected:** ${report.anomaliesDetected}

            ### Recommendations
            ${report.recommendations.map(rec => `- ${rec}`).join('\n')}

            [View detailed report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
              `;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

      - name: Fail build on QA failure
        if: steps.qa-validation.outcome == 'failure'
        run: |
          echo "QA Sentinel validation failed. Check the logs and reports for details."
          exit 1

  benchmark-comparison:
    runs-on: ubuntu-latest
    needs: qa-sentinel-validation
    if: github.event_name == 'push' || github.event_name == 'schedule'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run benchmark comparison
        run: |
          ./scripts/ci-cd/qa-sentinel-trigger.sh benchmark "${{ github.sha }}"

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-${{ github.sha }}
          path: reports/benchmark-*.json
          retention-days: 90

  performance-regression-alert:
    runs-on: ubuntu-latest
    needs: benchmark-comparison
    if: failure() && github.event_name == 'push'

    steps:
      - name: Create performance regression issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® Performance Regression Detected',
              body: `
            ## Performance Regression Alert

            A performance regression has been detected in the latest build.

            **Build:** ${{ github.sha }}
            **Branch:** ${{ github.ref }}
            **Workflow:** ${{ github.workflow }}

            ### Details
            The QA Sentinel benchmark comparison has detected performance degradation that exceeds acceptable thresholds.

            ### Next Steps
            1. Review the benchmark results in the workflow artifacts
            2. Investigate recent code changes that may have caused the regression
            3. Consider rolling back or optimizing the problematic changes

            [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
              `,
              labels: ['performance', 'regression', 'urgent']
            });

  anomaly-detection:
    runs-on: ubuntu-latest
    needs: qa-sentinel-validation
    if: github.event_name == 'schedule' || inputs.validation_type == 'anomaly'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Run anomaly detection
        run: |
          ./scripts/ci-cd/qa-sentinel-trigger.sh anomaly

      - name: Create anomaly alert
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üîç System Anomalies Detected',
              body: `
            ## System Anomaly Alert

            The QA Sentinel anomaly detection has identified unusual system behavior.

            **Detection Time:** ${new Date().toISOString()}
            **Environment:** CI/CD Pipeline

            ### Details
            Anomalies have been detected in system metrics that may indicate:
            - Performance degradation
            - Resource utilization issues
            - Potential security concerns
            - System instability

            ### Next Steps
            1. Review the anomaly detection logs
            2. Investigate recent deployments or configuration changes
            3. Monitor system metrics closely

            [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
              `,
              labels: ['anomaly', 'monitoring', 'investigation-needed']
            });