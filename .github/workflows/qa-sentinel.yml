name: QA Sentinel Validation

on:
  pull_request:
    branches: [ main, develop, v5.* ]
    paths:
      - 'core/**'
      - 'apps/**'
      - 'modules/**'
      - '!docs/**'
      - '!*.md'
  push:
    branches: [ main, v5.* ]
    paths:
      - 'core/**'
      - 'apps/**'
      - 'modules/**'
      - '!docs/**'
      - '!*.md'
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      validation_type:
        description: 'Type of validation to run'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - benchmark
          - anomaly
          - scheduled

jobs:
  qa-sentinel-validation:
    runs-on: ubuntu-latest
    environment: production
    outputs:
      qa_ready: ${{ steps.check_qa.outputs.ready }}
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: neonhub_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check QA Sentinel availability
        id: check_qa
        run: |
          node <<'NODE' > qa-status.txt
          const fs = require('fs');
          const path = require('path');
          const pkgPath = path.join('core', 'qa-sentinel', 'package.json');
          if (!fs.existsSync(pkgPath)) {
            console.log('status=missing-module');
            process.exit(0);
          }
          const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf8'));
          const scripts = pkg.scripts || {};
          const required = ['build', 'qa:validate', 'qa:scheduled', 'benchmark:compare', 'anomaly:detect', 'report:generate'];
          const missing = required.filter((name) => !scripts[name]);
          if (missing.length) {
            console.log('status=missing-scripts');
            console.log('missing=' + missing.join(','));
            process.exit(0);
          }
          console.log('status=ready');
          NODE
          STATUS=$(head -n1 qa-status.txt)
          echo "QA Sentinel status: $STATUS"
          if [ "$STATUS" = "status=ready" ]; then
            echo "ready=true" >> $GITHUB_OUTPUT
          else
            echo "ready=false" >> $GITHUB_OUTPUT
            if [ "$STATUS" = "status=missing-scripts" ]; then
              echo "missing=$(tail -n1 qa-status.txt | cut -d'=' -f2-)" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Log unavailable QA Sentinel
        if: steps.check_qa.outputs.ready != 'true'
        run: |
          echo "‚ö†Ô∏è QA Sentinel module unavailable or incomplete. Skipping automated QA validation."
          if [ -n "${{ steps.check_qa.outputs.missing }}" ]; then
            echo "Missing scripts: ${{ steps.check_qa.outputs.missing }}"
          fi

      - name: Setup Node.js
        if: steps.check_qa.outputs.ready == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Enable Corepack
        if: steps.check_qa.outputs.ready == 'true'
        run: corepack enable

      - name: Prepare pnpm
        if: steps.check_qa.outputs.ready == 'true'
        run: corepack prepare pnpm@9 --activate

      - name: Install dependencies
        if: steps.check_qa.outputs.ready == 'true'
        run: pnpm install --frozen-lockfile

      - name: Build QA Sentinel
        if: steps.check_qa.outputs.ready == 'true'
        run: |
          cd core/qa-sentinel
          npm run build

      - name: Setup test database
        if: steps.check_qa.outputs.ready == 'true'
        run: |
          pnpm --filter apps/api run prisma:migrate:deploy
          pnpm --filter apps/api run seed
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/neonhub_test

      - name: Run QA Sentinel validation
        if: steps.check_qa.outputs.ready == 'true'
        id: qa-validation
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            ./scripts/ci-cd/qa-sentinel-trigger.sh validate "${{ github.run_id }}" "${{ github.event.number }}"
          elif [ "${{ github.event_name }}" = "schedule" ] || [ "${{ inputs.validation_type }}" = "scheduled" ]; then
            ./scripts/ci-cd/qa-sentinel-trigger.sh scheduled
          elif [ "${{ inputs.validation_type }}" = "benchmark" ]; then
            ./scripts/ci-cd/qa-sentinel-trigger.sh benchmark "${{ github.run_id }}"
          elif [ "${{ inputs.validation_type }}" = "anomaly" ]; then
            ./scripts/ci-cd/qa-sentinel-trigger.sh anomaly
          else
            ./scripts/ci-cd/qa-sentinel-trigger.sh full "${{ github.run_id }}"
          fi
        env:
          NODE_ENV: test
          CI: true
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/neonhub_test
          REDIS_URL: redis://localhost:6379
          QA_SENTINEL_ENABLED: true

      - name: Generate QA report
        if: steps.check_qa.outputs.ready == 'true' && always()
        run: ./scripts/ci-cd/qa-sentinel-trigger.sh report

      - name: Upload QA artifacts
        if: steps.check_qa.outputs.ready == 'true' && always()
        uses: actions/upload-artifact@v4
        with:
          name: qa-sentinel-results-${{ github.run_id }}
          path: |
            logs/qa-sentinel-*.log
            reports/qa-sentinel-*.json
            core/qa-sentinel/coverage/
          retention-days: 30

      - name: Comment PR with QA results
        if: github.event_name == 'pull_request' && steps.check_qa.outputs.ready == 'true' && always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const reportsDir = 'reports';

            if (!fs.existsSync(reportsDir)) {
              console.log('No reports directory. Skipping comment.');
              return;
            }

            const reportFiles = fs.readdirSync(reportsDir)
              .filter(file => file.startsWith('qa-sentinel-report-'))
              .sort()
              .reverse();

            if (reportFiles.length === 0) {
              console.log('No QA reports found. Skipping comment.');
              return;
            }

            const reportPath = path.join(reportsDir, reportFiles[0]);
            let report;
            try {
              report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
            } catch (error) {
              core.warning(`Failed to parse QA report: ${error.message}`);
              return;
            }

            const recommendations = Array.isArray(report.recommendations)
              ? report.recommendations.map(rec => `- ${rec}`).join('\n')
              : '- No recommendations recorded';

            const body = `
            ## ü§ñ QA Sentinel Validation Results

            **Status:** ${report.status === 'success' ? '‚úÖ Passed' : '‚ùå Failed'}

            ### Test Results
            - **Total Tests:** ${report.totalTests ?? 'n/a'}
            - **Passed:** ${report.passedTests ?? 'n/a'}
            - **Failed:** ${report.failedTests ?? 'n/a'}
            - **Coverage:** ${report.coverage ?? 'n/a'}%

            ### Quality Metrics
            - **Performance Score:** ${report.performanceScore ?? 'n/a'}/100
            - **Anomalies Detected:** ${report.anomaliesDetected ?? 'n/a'}

            ### Recommendations
            ${recommendations}

            [View detailed report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

      - name: Fail build on QA failure
        if: steps.check_qa.outputs.ready == 'true' && steps.qa-validation.outcome == 'failure'
        run: |
          echo "QA Sentinel validation failed. Check the logs and reports for details."
          exit 1

  benchmark-comparison:
    runs-on: ubuntu-latest
    needs: qa-sentinel-validation
    if: (github.event_name == 'push' || github.event_name == 'schedule') && needs.qa-sentinel-validation.outputs.qa_ready == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Enable Corepack
        run: corepack enable

      - name: Prepare pnpm
        run: corepack prepare pnpm@9 --activate

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run benchmark comparison
        run: ./scripts/ci-cd/qa-sentinel-trigger.sh benchmark "${{ github.sha }}"

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-${{ github.sha }}
          path: reports/benchmark-*.json
          retention-days: 90

  performance-regression-alert:
    runs-on: ubuntu-latest
    needs: benchmark-comparison
    if: needs.benchmark-comparison.result == 'failure' && github.event_name == 'push'

    steps:
      - name: Create performance regression issue
        uses: actions/github-script@v6
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® Performance Regression Detected',
              body: `
            ## Performance Regression Alert

            A performance regression was detected in workflow run ${{ github.run_id }}.

            ### Recommended Actions
            - Review benchmark comparison artifacts
            - Investigate recent commits for potential performance impacts
            - Assign engineers to mitigate regression
              `,
              labels: ['ci-cd', 'performance', 'urgent']
            });

            core.info('Created issue #' + issue.data.number);
