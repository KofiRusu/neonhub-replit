name: DB Backup

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC

jobs:
  backup:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET || 'neonhub-db-backups' }}
      AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-2' }}
    steps:
      - name: Check DATABASE_URL
        run: |
          if [ -z "$DATABASE_URL" ]; then
            echo "::error::DATABASE_URL secret not configured"
            exit 1
          fi

      - uses: actions/checkout@v4

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Create backup
        id: backup
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          BACKUP_FILE="neonhub_backup_${TIMESTAMP}.sql"
          echo "BACKUP_FILE=${BACKUP_FILE}" >> $GITHUB_OUTPUT
          echo "TIMESTAMP=${TIMESTAMP}" >> $GITHUB_OUTPUT
          
          echo "üì¶ Creating backup: ${BACKUP_FILE}"
          pg_dump "$DATABASE_URL" \
            --no-owner \
            --no-acl \
            --clean \
            --if-exists \
            --format=plain \
            --file="${BACKUP_FILE}"
          
          # Compress backup
          gzip "${BACKUP_FILE}"
          echo "‚úÖ Backup created and compressed: ${BACKUP_FILE}.gz"
          ls -lh "${BACKUP_FILE}.gz"

      - name: Verify backup integrity
        run: |
          echo "üîç Verifying backup integrity..."
          gunzip -t "${{ steps.backup.outputs.BACKUP_FILE }}.gz"
          echo "‚úÖ Backup file is valid"

      - name: Upload to S3 (if configured)
        if: ${{ env.AWS_ACCESS_KEY_ID != '' }}
        run: |
          # Install AWS CLI
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip -q awscliv2.zip
          sudo ./aws/install
          
          # Upload backup
          aws s3 cp "${{ steps.backup.outputs.BACKUP_FILE }}.gz" \
            "s3://${AWS_S3_BUCKET}/backups/${{ steps.backup.outputs.BACKUP_FILE }}.gz" \
            --region "${AWS_REGION}"
          
          echo "‚úÖ Backup uploaded to S3: s3://${AWS_S3_BUCKET}/backups/${{ steps.backup.outputs.BACKUP_FILE }}.gz"

      - name: Upload as artifact (7-day retention)
        uses: actions/upload-artifact@v4
        with:
          name: db-backup-${{ steps.backup.outputs.TIMESTAMP }}
          path: ${{ steps.backup.outputs.BACKUP_FILE }}.gz
          retention-days: 7

      - name: Cleanup old backups (S3)
        if: ${{ env.AWS_ACCESS_KEY_ID != '' }}
        run: |
          echo "üßπ Cleaning up backups older than 30 days..."
          CUTOFF_DATE=$(date -d '30 days ago' +%Y%m%d)
          aws s3 ls "s3://${AWS_S3_BUCKET}/backups/" | while read -r line; do
            BACKUP_DATE=$(echo "$line" | grep -oP '\d{8}' | head -1)
            if [ "$BACKUP_DATE" -lt "$CUTOFF_DATE" ]; then
              FILE=$(echo "$line" | awk '{print $4}')
              echo "Deleting old backup: $FILE"
              aws s3 rm "s3://${AWS_S3_BUCKET}/backups/${FILE}"
            fi
          done

      - name: Summary
        if: always()
        run: |
          echo "## üì¶ Backup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: ${{ steps.backup.outputs.TIMESTAMP }}" >> $GITHUB_STEP_SUMMARY
          echo "- **File**: ${{ steps.backup.outputs.BACKUP_FILE }}.gz" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

      - name: Notify Slack (optional)
        if: always() && vars.SLACK_WEBHOOK_URL != ''
        run: |
          STATUS="${{ job.status }}"
          EMOJI="‚úÖ"
          [ "$STATUS" != "success" ] && EMOJI="‚ùå"
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"${EMOJI} *DB Backup* ${STATUS} - ${{ steps.backup.outputs.BACKUP_FILE }}.gz\"}" \
            ${{ secrets.SLACK_WEBHOOK_URL }} || true

