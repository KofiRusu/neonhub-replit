name: API Testing with Newman

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  schedule:
    - cron: "0 2 * * *"  # Daily at 2 AM UTC

jobs:
  api-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: neonhub_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9.12.2

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma client
        run: pnpm prisma:generate

      - name: Setup database schema
        env:
          DATABASE_URL: "postgresql://test:test@localhost:5432/neonhub_test"
        run: |
          cd apps/api
          pnpm prisma:migrate:deploy || true

      - name: Seed test data
        env:
          DATABASE_URL: "postgresql://test:test@localhost:5432/neonhub_test"
        run: pnpm db:seed:test || true

      - name: Start API server
        env:
          NODE_ENV: test
          DATABASE_URL: "postgresql://test:test@localhost:5432/neonhub_test"
          PORT: 3001
        run: |
          cd apps/api
          pnpm start > /tmp/api.log 2>&1 &
          echo $! > /tmp/api.pid
        timeout-minutes: 5

      - name: Wait for API to be ready
        run: |
          for i in {1..30}; do
            if curl -f http://localhost:3001/api/health 2>/dev/null; then
              echo "API is ready"
              exit 0
            fi
            echo "Waiting for API... ($i/30)"
            sleep 2
          done
          echo "API failed to start"
          cat /tmp/api.log || true
          exit 1

      - name: Run Newman tests
        run: pnpm test:api:newman

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: newman-results
          path: reports/newman/newman-results.xml

      - name: Publish test results
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: API Tests (Newman)
          path: "reports/newman/newman-results.xml"
          reporter: "java-junit"

      - name: Cleanup API process
        if: always()
        run: |
          if [ -f /tmp/api.pid ]; then
            kill $(cat /tmp/api.pid) || true
          fi

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const xmlPath = 'reports/newman/newman-results.xml';
            if (fs.existsSync(xmlPath)) {
              const xml = fs.readFileSync(xmlPath, 'utf8');
              const passed = (xml.match(/test results/g) || []).length;
              const body = `## API Testing Results\nâœ… Tests completed\n\nSee artifacts for detailed results.`;
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }

  perf-smoke:
    name: k6 Smoke
    runs-on: ubuntu-latest
    needs: api-tests
    if: ${{ secrets.API_TEST_TOKEN != '' }}
    timeout-minutes: 20
    env:
      API_BEARER_TOKEN: ${{ secrets.API_TEST_TOKEN }}
      API_EMAIL: ${{ secrets.API_TEST_EMAIL }}
      API_PASSWORD: ${{ secrets.API_TEST_PASSWORD }}

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: neonhub_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9.12.2

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma client
        run: pnpm prisma:generate

      - name: Setup database schema
        env:
          DATABASE_URL: "postgresql://test:test@localhost:5432/neonhub_test"
        run: |
          cd apps/api
          pnpm prisma:migrate:deploy || true

      - name: Seed test data
        env:
          DATABASE_URL: "postgresql://test:test@localhost:5432/neonhub_test"
        run: pnpm db:seed:test || true

      - name: Start API server
        env:
          NODE_ENV: test
          DATABASE_URL: "postgresql://test:test@localhost:5432/neonhub_test"
          PORT: 3001
        run: |
          cd apps/api
          pnpm start > /tmp/api-perf.log 2>&1 &
          echo $! > /tmp/api-perf.pid
        timeout-minutes: 5

      - name: Wait for API to be ready
        run: |
          for i in {1..30}; do
            if curl -f http://localhost:3001/api/health 2>/dev/null; then
              echo "API is ready"
              exit 0
            fi
            echo "Waiting for API... ($i/30)"
            sleep 2
          done
          echo "API failed to start"
          cat /tmp/api-perf.log || true
          exit 1

      - name: Setup k6
        uses: grafana/setup-k6-action@v0.5.0

      - name: Run k6 smoke suite
        env:
          API_BASE_URL: http://localhost:3001/api
          AUTH_BASE_URL: http://localhost:3000
          API_BEARER_TOKEN: ${{ secrets.API_TEST_TOKEN }}
          API_EMAIL: ${{ secrets.API_TEST_EMAIL }}
          API_PASSWORD: ${{ secrets.API_TEST_PASSWORD }}
        run: k6 run tests/perf/smoke-api.js

      - name: Cleanup API process
        if: always()
        run: |
          if [ -f /tmp/api-perf.pid ]; then
            kill $(cat /tmp/api-perf.pid) || true
          fi
