# NeonHub Database Audit — 2025-01-26

## Executive Summary
- Prisma schema lives in `apps/api/prisma/schema.prisma`; migrations folder only covers early auth/core features (20251012154609_initial, 20250105_phase4_beta) and omits the majority of currently modelled tables.
- Local tooling uses Prisma 5.22.0 on Node 20.17.0, but `pnpm` is not installed, causing `npx prisma generate` to fail (`spawn pnpm ENOENT`) and blocking client generation.
- `.env` resolves `DATABASE_URL=postgresql://****:****@localhost:5432/neonhub`, yet Postgres is not reachable; `prisma db pull` and `prisma migrate status` both return `P1001` (connection refused).
- No Prisma enums, no vector fields, and no references to `pgvector`; embeddings, IVFFLAT indexes, and extension management are absent.
- Required domain entities (Organization, Membership, Roles/Permissions, ApiKey, Brand, BrandVoice, EmbeddingSpace, Agent*, Conversation, Dataset, Chunk, ModelVersion, TrainingJob, InferenceEndpoint, Content, CampaignMetric, etc.) are missing from the schema.
- Even models present in the datamodel (Campaign, EmailSequence, SocialPost, Subscription, Invoice, UsageRecord, Connector*, Message, Task, Feedback, Document) lack corresponding migration SQL, implying applied databases are missing these tables.
- Hot-path indexes for message timelines, agent runs, campaign metrics, and chunk ordering do not exist; no composite or unique constraints on slugs/identifiers beyond auth/email.
- Seed script (`apps/api/prisma/seed.ts`) only populates a demo user, drafts, agent jobs, and metric events—none of the required Org/Brand/Agent/RAG baseline entities.
- `.tmp/db-drift.sql` generated by `prisma migrate diff` is empty because connectivity failed; runtime drift is unknown but Prisma’s migration history already lags behind the datamodel.
- Risk level is high: RBAC, compliance logging, AI/embedding features, and performance safeguards are not implemented in the database layer.

## 1. Environment & Connectivity
- **Node / Prisma**: Node v20.17.0, Prisma CLI 5.22.0 (`npx prisma -v`).
- **Package manager**: `pnpm` unavailable (`bash: pnpm: command not found`), resulting in `spawn pnpm ENOENT` during `prisma generate`.
- **Datasource**: `.env` and templates point to `postgresql://****:****@localhost:5432/neonhub`; app config expects the same DSN (`apps/api/src/config/env.ts:98`).
- **Connectivity**: `prisma db pull` & `prisma migrate status` fail with `P1001` (server unreachable). No evidence of remote DB wiring in CI workflows; GitHub Actions reference `postgresql://postgres:postgres@localhost:5432/neonhub_test` for tests.

## 2. Prisma Assets & Migrations
- **Schema files**:
  - Primary: `apps/api/prisma/schema.prisma`.
  - Web mirror: `apps/web/prisma/schema.prisma` (NextAuth subset).
- **Migrations**:
  - `20251012154609_initial`: Auth + Drafts + AgentJobs + MetricEvents tables and indexes.
  - `20250105_phase4_beta`: Documents, Tasks, Feedback, Messages, TeamMembers, Connectors (+ triggers).
  - No migration covers Campaigns, Credentials, Subscriptions, Billing, or connector configs despite their presence in the datamodel.
- **Formatting**: `npx prisma format` applied (schema now reformatted only; functional content unchanged).
- **Diff attempt**: `npx prisma migrate diff --to-url "$DATABASE_URL"` failed (DB unreachable); `.tmp/db-drift.sql` left empty.

## 3. Schema Coverage vs Target
| Domain | Expected Entities | Status | Notes |
| --- | --- | --- | --- |
| Identity & Org | User, Organization, Membership, Role, Permission, ApiKey, Credential | **Missing / Partial** | `User` + `Credential` exist; no Organization/RBAC tables, no API keys, no membership bridging. |
| Brand System | Brand, BrandVoice (promptTemplate/styleRulesJson/vector), EmbeddingSpace | **Missing** | No brand tables, no embeddings, style rules only stored as `UserSettings.brandVoice` JSON. |
| Agents | Agent, AgentConfig, AgentCapability, Tool, ToolExecution, AgentRun (+ enums) | **Missing** | Only `AgentJob` (legacy job queue) exists; no agent registry or telemetry tables. |
| Chats | Conversation, Message(role, contentJson, embedding) | **Partial** | `Message` lacks `conversationId`, `role`, `contentJson`, `embedding`; `Conversation` table absent. |
| Data / RAG | Dataset, Document, Chunk(embedding, idx), ModelVersion, TrainingJob, InferenceEndpoint | **Missing / Partial** | `Document` exists but no references to datasets or embeddings; all other tables absent. |
| Content & Campaigns | Content, Campaign, CampaignMetric | **Partial** | `Campaign`, `EmailSequence`, `SocialPost`, `ABTest` in schema but never migrated; no `Content`/`CampaignMetric`. |
| Governance / Audit | AuditLog | **Partial** | `AuditLog` exists but lacks org scoping, event enums, or retention policies. |
| Enums | AgentKind, AgentStatus, MessageRole, ConversationKind, DatasetKind, TrainStatus, ContentKind, CampaignStatus | **Missing** | No Prisma enums defined; status fields are plain strings without constraints. |

## 4. Constraints, Indexes & Performance
- **Reachable indexes**: Auth tables have expected uniques; Campaign/Task/Message indexes declared in schema but migrations absent.
- **Missing composites**: No indexes on `CampaignMetric` (table missing), `AgentRun`, `Chunk`, or `Conversation` (absent). Compound uniqueness for slugs, dataset identifiers, or API keys missing.
- **Foreign key policies**: Many relations default to `onDelete: Cascade` but absent tables mean referential integrity is incomplete. No cascading removal for brand or dataset hierarchies.
- **Vector / full-text**: No `@db.Vector`, no trigram/GIN indexes for JSON or text search. Performance-critical filters on large JSON columns (e.g., `Message.metadata`, `Connector.*`) lack supporting indexes.

## 5. Vector & AI Posture
- **pgvector**: Not referenced in schema; extension management SQL absent. No dimension hints or indexes for embeddings.
- **Embedding storage**: `Message` and `Document` models lack embedding columns; there are no `Chunk` objects to support RAG.
- **Agent telemetry**: Without `AgentRun`/`ToolExecution`, there is no instrumentation for latency, tokens, or compliance auditing.

## 6. Seeds & Data Health
- **Seed script**: `apps/api/prisma/seed.ts` seeds a single user, two drafts, two agent jobs, and three metric events. No organizations, brand voices, agents, conversations, datasets, or campaigns.
- **Fixtures**: No dataset in `apps/api/prisma/seed.ts` for baseline Org/Admin, brand voice, or embeddings; e2e needs (`pnpm --filter apps/web test:e2e`) cannot rely on seeded data.
- **Tests**: Backend coverage expects 95% but no DB fixtures exist for new domains; CI would fail once schema expands without updated seeds.

## 7. Risks & Gaps
- **High**:
  - Database cannot connect; migrations and drift unknown.
  - Missing Org/RBAC tables prevents enforcing tenant isolation and compliance.
  - No vector storage/indexing; AI agents cannot persist embeddings or run similarity search.
  - Migration history lags datamodel—deployments would create empty tables or fail entirely.
- **Medium**:
  - `pnpm` absence blocks Prisma client generation during build pipelines.
  - Seeds inadequate for automated tests or demos; any new schema would leave DB empty.
  - Lack of enums invites data quality drift (status strings inconsistent).
  - Missing composite indexes on time-series (messages, metrics) risks slow queries.
- **Low**:
  - Triggers for updatedAt only on Phase 4 tables; other tables rely on Prisma defaults.
  - No archival/retention strategy surfaced (AuditLog growth unbounded).

## 8. Immediate Follow-Ups (Pre-Fix)
1. Install `pnpm` (or enable via Corepack) so Prisma can generate clients locally and in CI.
2. Provision a reachable Postgres 14+ instance with `vector` extension enabled; update `.env` accordingly.
3. Snapshot current production/staging schema (if any) before introducing structural changes.
4. Align Prisma schema + migrations with the target domain model prior to running `prisma migrate dev`.
5. Expand seeds to cover Org/Admin, Brand Voice Copilot, agents, sample conversation, dataset/chunk, and campaign metrics.
