// NeonHub Prisma schema aligned with Postgres + pgvector

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

enum AgentKind {
  COPILOT
  WORKFLOW
  ANALYST
}

enum AgentStatus {
  DRAFT
  ACTIVE
  PAUSED
  DISABLED
}

enum MessageRole {
  system
  user
  assistant
  tool
}

enum ConversationKind {
  support
  campaign
  planning
  ad_hoc
}

enum DatasetKind {
  documents
  faq
  analytics
}

enum TrainStatus {
  queued
  running
  completed
  failed
  cancelled
}

enum ContentKind {
  article
  email
  social_script
  ad_copy
}

enum CampaignStatus {
  draft
  scheduled
  active
  paused
  completed
  archived
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  image         String?
  emailVerified DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts               Account[]
  sessions               Session[]
  contentDrafts          ContentDraft[]
  agentJobs              AgentJob[]
  credentials            Credential[]
  settings               UserSettings?
  subscription           Subscription?
  auditLogs              AuditLog[]
  organizationMembership OrganizationMembership[]
  apiKeys                ApiKey[]                 @relation("ApiKeyCreator")
  conversations          Conversation[]           @relation("ConversationCreator")
  messages               Message[]                @relation("MessageAuthor")
  documents              Document[]               @relation("DocumentOwner")
  tasksCreated           Task[]                   @relation("TaskCreator")
  tasksAssigned          Task[]                   @relation("TaskAssignee")
  feedback               Feedback[]
  connectorAuths         ConnectorAuth[]
  teamMemberships        TeamMember[]
  campaigns              Campaign[]

  stripeCustomerId String?   @unique
  isBetaUser       Boolean   @default(false)
  Content          Content[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Organization {
  id        String   @id @default(cuid())
  slug      String   @unique
  name      String
  plan      String   @default("starter")
  settings  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members           OrganizationMembership[]
  roles             OrganizationRole[]
  permissions       OrganizationPermission[]
  apiKeys           ApiKey[]
  brands            Brand[]
  embeddingSpaces   EmbeddingSpace[]
  agents            Agent[]
  datasets          Dataset[]
  modelVersions     ModelVersion[]
  campaigns         Campaign[]
  conversations     Conversation[]
  contentItems      Content[]
  auditLogs         AuditLog[]
  AgentRun          AgentRun[]
  Tool              Tool[]
  Document          Document[]
  InferenceEndpoint InferenceEndpoint[]
  ContentDraft      ContentDraft[]
  AgentJob          AgentJob[]
  Task              Task[]
  Feedback          Feedback[]
  TeamMember        TeamMember[]
  ConnectorAuth     ConnectorAuth[]
}

model OrganizationRole {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  slug           String
  description    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization    Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  rolePermissions RolePermission[]
  memberships     OrganizationMembership[]

  @@unique([organizationId, slug])
}

model OrganizationPermission {
  id             String   @id @default(cuid())
  organizationId String
  key            String
  description    String?
  createdAt      DateTime @default(now())

  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  rolePermissions RolePermission[]

  @@unique([organizationId, key])
}

model RolePermission {
  roleId       String
  permissionId String

  role       OrganizationRole       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission OrganizationPermission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
}

model OrganizationMembership {
  id             String   @id @default(cuid())
  organizationId String
  userId         String
  roleId         String?
  status         String   @default("active")
  invitedById    String?
  joinedAt       DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  role         OrganizationRole? @relation(fields: [roleId], references: [id], onDelete: SetNull)

  @@unique([organizationId, userId])
}

model ApiKey {
  id             String    @id @default(cuid())
  organizationId String
  userId         String
  name           String
  keyHash        String
  scopes         String[]  @default([])
  lastUsedAt     DateTime?
  expiresAt      DateTime?
  revokedAt      DateTime?
  createdAt      DateTime  @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  creator      User         @relation("ApiKeyCreator", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, keyHash])
  @@unique([userId, keyHash])
}

model EmbeddingSpace {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  provider       String
  model          String
  dimension      Int
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  brandVoices  BrandVoice[]
  datasets     Dataset[]
  chunks       Chunk[]
  Document     Document[]
}

model Brand {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  slug           String
  description    String?
  mainColor      String?
  slogan         String?
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  brandVoices  BrandVoice[]
  assets       BrandAsset[]

  @@unique([organizationId, slug])
}

model BrandVoice {
  id               String                @id @default(cuid())
  brandId          String
  embeddingSpaceId String
  promptTemplate   String                @db.Text
  styleRulesJson   Json
  embedding        Unsupported("vector")
  metrics          Json?
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt

  brand          Brand          @relation(fields: [brandId], references: [id], onDelete: Cascade)
  embeddingSpace EmbeddingSpace @relation(fields: [embeddingSpaceId], references: [id], onDelete: Cascade)
}

model BrandAsset {
  id        String   @id @default(cuid())
  brandId   String
  kind      String
  name      String
  url       String?
  metadata  Json?
  createdAt DateTime @default(now())

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)
}

model Agent {
  id             String      @id @default(cuid())
  organizationId String
  name           String
  slug           String
  kind           AgentKind
  status         AgentStatus @default(ACTIVE)
  description    String?
  version        String?
  config         Json?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  capabilities AgentCapability[]
  configs      AgentConfig[]
  runs         AgentRun[]
  tools        Tool[]

  @@unique([organizationId, slug])
}

model AgentCapability {
  id        String   @id @default(cuid())
  agentId   String
  name      String
  config    Json?
  createdAt DateTime @default(now())

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)
}

model AgentConfig {
  id        String   @id @default(cuid())
  agentId   String
  key       String
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([agentId, key])
}

model AgentRun {
  id             String    @id @default(cuid())
  agentId        String
  organizationId String
  datasetId      String?
  status         String    @default("queued")
  input          Json
  output         Json?
  metrics        Json?
  startedAt      DateTime  @default(now())
  completedAt    DateTime?

  agent          Agent            @relation(fields: [agentId], references: [id], onDelete: Cascade)
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  dataset        Dataset?         @relation(fields: [datasetId], references: [id], onDelete: SetNull)
  toolExecutions ToolExecution[]
  runMetrics     AgentRunMetric[]

  @@index([agentId, startedAt])
}

model AgentRunMetric {
  id         String @id @default(cuid())
  agentRunId String
  name       String
  value      Float?
  metadata   Json?

  agentRun AgentRun @relation(fields: [agentRunId], references: [id], onDelete: Cascade)
}

model Tool {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  slug           String
  description    String?
  inputSchema    Json?
  outputSchema   Json?
  createdAt      DateTime @default(now())

  organization Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  executions   ToolExecution[]
  Agent        Agent?          @relation(fields: [agentId], references: [id])
  agentId      String?

  @@unique([organizationId, slug])
}

model ToolExecution {
  id          String    @id @default(cuid())
  toolId      String
  agentRunId  String?
  status      String    @default("queued")
  input       Json?
  output      Json?
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  metadata    Json?

  tool     Tool      @relation(fields: [toolId], references: [id], onDelete: Cascade)
  agentRun AgentRun? @relation(fields: [agentRunId], references: [id], onDelete: SetNull)
}

model Conversation {
  id             String           @id @default(cuid())
  organizationId String
  kind           ConversationKind @default(support)
  status         String           @default("active")
  title          String?
  createdById    String?
  metadata       Json?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy    User?        @relation("ConversationCreator", fields: [createdById], references: [id], onDelete: SetNull)
  messages     Message[]

  @@index([organizationId, createdAt])
}

model Message {
  id             String                @id @default(cuid())
  conversationId String
  authorId       String?
  role           MessageRole
  contentJson    Json
  embedding      Unsupported("vector")
  metadata       Json?
  createdAt      DateTime              @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  author       User?        @relation("MessageAuthor", fields: [authorId], references: [id], onDelete: SetNull)

  @@index([conversationId, createdAt])
  @@index([role, createdAt])
}

model Dataset {
  id               String      @id @default(cuid())
  organizationId   String
  embeddingSpaceId String?
  name             String
  slug             String
  kind             DatasetKind
  description      String?
  source           String?
  metadata         Json?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  embeddingSpace EmbeddingSpace? @relation(fields: [embeddingSpaceId], references: [id], onDelete: SetNull)
  documents      Document[]
  chunks         Chunk[]
  AgentRun       AgentRun[]

  @@unique([organizationId, slug])
}

model Document {
  id               String   @id @default(cuid())
  datasetId        String?
  organizationId   String
  ownerId          String
  embeddingSpaceId String?
  title            String
  content          String   @db.Text
  status           String   @default("draft")
  metadata         Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  dataset        Dataset?        @relation(fields: [datasetId], references: [id], onDelete: SetNull)
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  owner          User            @relation("DocumentOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  embeddingSpace EmbeddingSpace? @relation(fields: [embeddingSpaceId], references: [id], onDelete: SetNull)
  chunks         Chunk[]
}

model Chunk {
  id               String                @id @default(cuid())
  datasetId        String
  documentId       String
  embeddingSpaceId String
  idx              Int
  text             String                @db.Text
  embedding        Unsupported("vector")
  metadata         Json?
  createdAt        DateTime              @default(now())

  dataset        Dataset        @relation(fields: [datasetId], references: [id], onDelete: Cascade)
  document       Document       @relation(fields: [documentId], references: [id], onDelete: Cascade)
  embeddingSpace EmbeddingSpace @relation(fields: [embeddingSpaceId], references: [id], onDelete: Cascade)

  @@unique([datasetId, idx])
  @@index([embeddingSpaceId])
}

model ModelVersion {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  provider       String
  version        String
  metadata       Json?
  createdAt      DateTime @default(now())

  organization Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  trainingJobs TrainingJob[]
  endpoints    InferenceEndpoint[]
}

model TrainingJob {
  id             String      @id @default(cuid())
  modelVersionId String
  status         TrainStatus @default(queued)
  config         Json
  metrics        Json?
  startedAt      DateTime    @default(now())
  completedAt    DateTime?

  modelVersion ModelVersion @relation(fields: [modelVersionId], references: [id], onDelete: Cascade)
}

model InferenceEndpoint {
  id             String   @id @default(cuid())
  organizationId String
  modelVersionId String?
  name           String
  slug           String
  status         String   @default("draft")
  config         Json?
  createdAt      DateTime @default(now())

  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  modelVersion ModelVersion? @relation(fields: [modelVersionId], references: [id], onDelete: SetNull)

  @@unique([organizationId, slug])
}

model Content {
  id             String      @id @default(cuid())
  organizationId String
  authorId       String?
  kind           ContentKind
  status         String      @default("draft")
  title          String?
  body           String?     @db.Text
  metadata       Json?
  publishedAt    DateTime?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  author       User?        @relation(fields: [authorId], references: [id], onDelete: SetNull)
}

model Campaign {
  id             String         @id @default(cuid())
  organizationId String
  ownerId        String
  name           String
  status         CampaignStatus @default(draft)
  type           String
  config         Json?
  schedule       Json?
  budget         Json?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  owner          User             @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  metrics        CampaignMetric[]
  emailSequences EmailSequence[]
  socialPosts    SocialPost[]
  abTests        ABTest[]

  @@index([organizationId, status])
}

model CampaignMetric {
  id         String   @id @default(cuid())
  campaignId String
  kind       String
  value      Float?
  payload    Json?
  ts         DateTime @default(now())

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId, kind, ts])
}

model EmailSequence {
  id           String    @id @default(cuid())
  campaignId   String
  subject      String
  body         String    @db.Text
  variant      String?
  scheduledFor DateTime?
  sentAt       DateTime?
  metrics      Json?
  createdAt    DateTime  @default(now())

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId, scheduledFor])
  @@map("email_sequences")
}

model SocialPost {
  id           String    @id @default(cuid())
  campaignId   String
  platform     String
  content      String    @db.Text
  mediaUrls    Json?
  variant      String?
  scheduledFor DateTime?
  publishedAt  DateTime?
  externalId   String?
  metrics      Json?
  createdAt    DateTime  @default(now())

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId, platform, scheduledFor])
  @@map("social_posts")
}

model ABTest {
  id          String    @id @default(cuid())
  campaignId  String
  name        String
  variants    Json
  winner      String?
  metrics     Json
  startedAt   DateTime  @default(now())
  completedAt DateTime?

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@map("ab_tests")
}

model ContentDraft {
  id             String   @id @default(cuid())
  organizationId String?
  title          String
  topic          String
  body           String   @db.Text
  tone           String   @default("professional")
  audience       String?
  status         String   @default("draft")
  createdById    String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  createdBy    User          @relation(fields: [createdById], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  @@index([createdById, status])
  @@index([createdAt])
  @@map("content_drafts")
}

model AgentJob {
  id             String   @id @default(cuid())
  organizationId String?
  agent          String
  input          Json
  output         Json?
  status         String   @default("queued")
  error          String?  @db.Text
  metrics        Json?
  createdById    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  createdBy    User?         @relation(fields: [createdById], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  @@index([agent])
  @@index([status])
  @@index([createdAt])
  @@map("agent_jobs")
}

model MetricEvent {
  id        String   @id @default(cuid())
  type      String
  meta      Json
  createdAt DateTime @default(now())

  @@index([type])
  @@index([createdAt])
  @@map("metric_events")
}

model Credential {
  id           String    @id @default(cuid())
  userId       String
  provider     String
  accountId    String?
  accessToken  String?   @db.Text
  refreshToken String?   @db.Text
  accessSecret String?   @db.Text
  scope        String?
  tokenType    String?
  expiresAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  lastUsedAt   DateTime?
  status       String    @default("active")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider, accountId])
  @@index([userId, provider])
  @@map("credentials")
}

model UserSettings {
  id                    String   @id @default(cuid())
  userId                String   @unique
  brandVoice            Json?
  emailNotifications    Boolean  @default(true)
  pushNotifications     Boolean  @default(false)
  notificationFrequency String   @default("realtime")
  timezone              String   @default("UTC")
  locale                String   @default("en-US")
  dateFormat            String   @default("MM/DD/YYYY")
  dataRetention         Int      @default(90)
  allowAnalytics        Boolean  @default(true)
  allowPersonalization  Boolean  @default(true)
  apiRateLimit          Int      @default(1000)
  webhookUrl            String?
  webhookSecret         String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

model Subscription {
  id                   String    @id @default(cuid())
  userId               String    @unique
  stripeCustomerId     String    @unique
  stripeSubscriptionId String    @unique
  stripePriceId        String
  stripeProductId      String
  plan                 String
  status               String
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean   @default(false)
  canceledAt           DateTime?
  campaignsUsed        Int       @default(0)
  emailsSent           Int       @default(0)
  socialPosts          Int       @default(0)
  agentCalls           Int       @default(0)
  campaignLimit        Int       @default(5)
  emailLimit           Int       @default(1000)
  socialLimit          Int       @default(100)
  agentCallLimit       Int       @default(100)
  trialEndsAt          DateTime?
  metadata             Json?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoices     Invoice[]
  usageRecords UsageRecord[]

  @@map("subscriptions")
}

model Invoice {
  id                    String    @id @default(cuid())
  subscriptionId        String
  stripeInvoiceId       String    @unique
  stripePaymentIntentId String?
  amountDue             Int
  amountPaid            Int       @default(0)
  currency              String    @default("usd")
  status                String
  invoicePdf            String?
  hostedInvoiceUrl      String?
  dueDate               DateTime?
  paidAt                DateTime?
  metadata              Json?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId, status])
  @@map("invoices")
}

model UsageRecord {
  id             String   @id @default(cuid())
  subscriptionId String
  resourceType   String
  resourceId     String?
  quantity       Int      @default(1)
  cost           Int?
  timestamp      DateTime @default(now())
  metadata       Json?

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId, resourceType, timestamp])
  @@map("usage_records")
}

model AuditLog {
  id             String   @id @default(cuid())
  organizationId String?
  userId         String?
  actorType      String?
  action         String
  resourceId     String?
  resourceType   String?
  requestHash    String?
  metadata       Json?
  ip             String?
  createdAt      DateTime @default(now())

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  user         User?         @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([organizationId, createdAt])
  @@index([userId, createdAt])
  @@index([action])
  @@map("audit_logs")
}

model Task {
  id             String    @id @default(cuid())
  organizationId String?
  title          String
  description    String?   @db.Text
  status         String    @default("todo")
  priority       String    @default("medium")
  createdById    String
  assigneeId     String?
  dueDate        DateTime?
  completedAt    DateTime?
  tags           String[]
  metadata       Json?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  createdBy    User          @relation("TaskCreator", fields: [createdById], references: [id], onDelete: Cascade)
  assignee     User?         @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)

  @@index([createdById, status])
  @@index([assigneeId, status])
  @@index([dueDate])
  @@map("tasks")
}

model Feedback {
  id             String    @id @default(cuid())
  organizationId String?
  type           String
  category       String?
  title          String
  description    String    @db.Text
  rating         Int?
  status         String    @default("open")
  userId         String
  metadata       Json?
  response       String?   @db.Text
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  resolvedAt     DateTime?

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([type, status])
  @@index([createdAt])
  @@map("feedback")
}

model TeamMember {
  id             String    @id @default(cuid())
  organizationId String?
  userId         String
  role           String    @default("Member")
  department     String?
  status         String    @default("active")
  invitedBy      String?
  invitedAt      DateTime?
  joinedAt       DateTime  @default(now())
  metadata       Json?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([role, status])
  @@map("team_members")
}

model Connector {
  id          String   @id @default(cuid())
  name        String   @unique
  displayName String
  description String   @db.Text
  category    String
  iconUrl     String?
  websiteUrl  String?
  authType    String
  authConfig  Json
  isEnabled   Boolean  @default(true)
  isVerified  Boolean  @default(false)
  triggers    Json
  actions     Json
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  connectorAuths ConnectorAuth[]

  @@map("connectors")
}

model ConnectorAuth {
  id             String    @id @default(cuid())
  userId         String
  connectorId    String
  organizationId String?
  accountId      String?
  accountName    String?
  accessToken    String?   @db.Text
  refreshToken   String?   @db.Text
  apiKey         String?   @db.Text
  apiSecret      String?   @db.Text
  scope          String?
  tokenType      String?
  expiresAt      DateTime?
  status         String    @default("active")
  lastUsedAt     DateTime?
  lastError      String?   @db.Text
  metadata       Json?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  connector      Connector       @relation(fields: [connectorId], references: [id], onDelete: Cascade)
  organization   Organization?   @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  triggerConfigs TriggerConfig[]
  actionConfigs  ActionConfig[]

  @@unique([userId, connectorId, accountId])
  @@index([userId, connectorId])
  @@map("connector_auths")
}

model TriggerConfig {
  id              String    @id @default(cuid())
  connectorAuthId String
  name            String
  triggerType     String
  config          Json
  isActive        Boolean   @default(true)
  lastTriggeredAt DateTime?
  triggerCount    Int       @default(0)
  metadata        Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  connectorAuth ConnectorAuth @relation(fields: [connectorAuthId], references: [id], onDelete: Cascade)

  @@index([connectorAuthId, isActive])
  @@map("trigger_configs")
}

model ActionConfig {
  id              String    @id @default(cuid())
  connectorAuthId String
  name            String
  actionType      String
  config          Json
  isActive        Boolean   @default(true)
  lastExecutedAt  DateTime?
  executionCount  Int       @default(0)
  metadata        Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  connectorAuth ConnectorAuth @relation(fields: [connectorAuthId], references: [id], onDelete: Cascade)

  @@index([connectorAuthId, isActive])
  @@map("action_configs")
}
