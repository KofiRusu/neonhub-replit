#!/usr/bin/env sh
. "$(dirname "$0")/_/husky.sh"

# Escape hatch for emergencies
if [ -n "$SKIP_HUSKY" ]; then
  echo "SKIP_HUSKY set - skipping pre-commit checks"
  exit 0
fi

pnpm_cmd="pnpm"
if ! command -v pnpm >/dev/null 2>&1; then
  pnpm_cmd="npx --yes pnpm"
fi

echo "Running pre-commit lint (apps/web)..."
if ! $pnpm_cmd --filter apps/web run lint:strict; then
  echo "Lint failed - aborting commit"
  exit 1
fi

if [ -z "$SKIP_TESTS" ]; then
  echo "Running quick tests..."
  if ! $pnpm_cmd --filter apps/api run test -- --runInBand --ci --passWithNoTests; then
    status=$?
    if [ "$status" -eq 127 ]; then
      echo "Jest not available - skipping quick tests (install dependencies to re-enable)"
    else
      echo "Quick tests failed - aborting commit"
      exit $status
    fi
  fi
else
  echo "SKIP_TESTS set - skipping tests in pre-commit"
fi
