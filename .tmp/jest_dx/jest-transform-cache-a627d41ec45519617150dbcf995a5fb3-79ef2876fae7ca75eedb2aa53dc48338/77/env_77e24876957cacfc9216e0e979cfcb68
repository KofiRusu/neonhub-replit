c2b6ef796ff8b9a451703f267c62a017
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getEnv = exports.env = void 0;
exports.validateEnv = validateEnv;
const zod_1 = require("zod");
const envSchema = zod_1.z.object({
    // Database
    DATABASE_URL: zod_1.z.string().url('DATABASE_URL must be a valid URL'),
    // Authentication  
    NEXTAUTH_SECRET: zod_1.z.string().min(32, 'NEXTAUTH_SECRET must be at least 32 characters'),
    NEXTAUTH_URL: zod_1.z.string().url('NEXTAUTH_URL must be a valid URL'),
    // CORS
    CORS_ORIGINS: zod_1.z.string().min(1, 'CORS_ORIGINS must be provided').transform((val) => val.split(',').map(origin => origin.trim()).filter(Boolean)),
    // Infrastructure
    REDIS_URL: zod_1.z.string().url().optional(),
    // Payment
    STRIPE_SECRET_KEY: zod_1.z.string().min(1, 'STRIPE_SECRET_KEY is required'),
    STRIPE_WEBHOOK_SECRET: zod_1.z.string().min(1, 'STRIPE_WEBHOOK_SECRET is required'),
    // External APIs
    RESEND_API_KEY: zod_1.z.string().min(1, 'RESEND_API_KEY is required'),
    OPENAI_API_KEY: zod_1.z.string().min(1, 'OPENAI_API_KEY is required'),
    OPENAI_MODEL: zod_1.z.string().default('gpt-4'),
    // Environment
    NODE_ENV: zod_1.z.enum(['development', 'production', 'test']).default('development'),
    PORT: zod_1.z.coerce.number().positive().default(3001),
    // Beta Program
    BETA_ENABLED: zod_1.z.coerce.boolean().default(false),
    // Optional - Monitoring
    SENTRY_DSN: zod_1.z.string().url().optional(),
    // Optional - SMS
    TWILIO_ACCOUNT_SID: zod_1.z.string().optional(),
    TWILIO_SID: zod_1.z.string().optional(),
    TWILIO_AUTH_TOKEN: zod_1.z.string().optional(),
    TWILIO_PHONE_NUMBER: zod_1.z.string().optional(),
    // Social APIs (for trends service)
    TWITTER_BEARER_TOKEN: zod_1.z.string().optional(),
    REDDIT_CLIENT_ID: zod_1.z.string().optional(),
    REDDIT_CLIENT_SECRET: zod_1.z.string().optional(),
    REDDIT_USER_AGENT: zod_1.z.string().default('NeonHub/3.2'),
});
let hasWarnedNonProd = false;
function validateEnv() {
    try {
        return envSchema.parse(process.env);
    }
    catch (error) {
        if (error instanceof zod_1.z.ZodError) {
            const missingVars = error.errors.map(err => `${err.path.join('.')}: ${err.message}`).join('\n');
            console.error('❌ Environment validation failed:\n' + missingVars);
            const nodeEnv = (process.env.NODE_ENV ?? 'development').toLowerCase();
            const isJestRuntime = Boolean(process.env.JEST_WORKER_ID) ||
                process.argv.some((arg) => arg.includes('jest'));
            if (nodeEnv !== 'production' || isJestRuntime) {
                if (!hasWarnedNonProd) {
                    console.warn('⚠️  Using relaxed environment defaults. Set required variables or run `npm run verify` before production deploys.');
                    hasWarnedNonProd = true;
                }
                return buildFallbackEnv(nodeEnv === 'test' || isJestRuntime ? 'test' : 'development');
            }
            throw new Error(`Environment validation failed:\n${missingVars}`);
        }
        throw error;
    }
}
// Singleton instance - skip strict validation in test mode
let _env = null;
function parseOrigins(raw) {
    if (Array.isArray(raw)) {
        return raw;
    }
    if (!raw) {
        return ['http://localhost:3000'];
    }
    return raw
        .split(',')
        .map((origin) => origin.trim())
        .filter(Boolean);
}
function buildFallbackEnv(target) {
    const defaults = {
        DATABASE_URL: process.env.DATABASE_URL ||
            (target === 'test'
                ? 'postgresql://test:test@localhost:5432/test'
                : 'postgresql://localhost:5432/neonhub'),
        NEXTAUTH_SECRET: process.env.NEXTAUTH_SECRET ||
            (target === 'test'
                ? 'test-secret-min-32-chars-long-12345'
                : 'dev-secret-min-32-chars-long-12345'),
        NEXTAUTH_URL: process.env.NEXTAUTH_URL || 'http://localhost:3000',
        CORS_ORIGINS: parseOrigins(process.env.CORS_ORIGINS),
        REDIS_URL: process.env.REDIS_URL || 'redis://localhost:6379',
        STRIPE_SECRET_KEY: process.env.STRIPE_SECRET_KEY ||
            (target === 'test' ? 'sk_test_fake' : 'sk_test_dev'),
        STRIPE_WEBHOOK_SECRET: process.env.STRIPE_WEBHOOK_SECRET ||
            (target === 'test' ? 'whsec_test_fake' : 'whsec_dev_fake'),
        RESEND_API_KEY: process.env.RESEND_API_KEY || 'test_fake',
        OPENAI_API_KEY: process.env.OPENAI_API_KEY ||
            (target === 'test'
                ? 'test-key-for-testing'
                : 'test-key-for-development'),
        OPENAI_MODEL: process.env.OPENAI_MODEL || 'gpt-4',
        NODE_ENV: target,
        PORT: Number(process.env.PORT ?? 3001),
        SENTRY_DSN: process.env.SENTRY_DSN,
        TWILIO_ACCOUNT_SID: process.env.TWILIO_ACCOUNT_SID,
        TWILIO_SID: process.env.TWILIO_SID || process.env.TWILIO_ACCOUNT_SID,
        TWILIO_AUTH_TOKEN: process.env.TWILIO_AUTH_TOKEN,
        TWILIO_PHONE_NUMBER: process.env.TWILIO_PHONE_NUMBER,
    };
    return defaults;
}
exports.env = (() => {
    if (_env)
        return _env;
    const nodeEnv = (process.env.NODE_ENV ?? 'development').toLowerCase();
    const isJestRuntime = Boolean(process.env.JEST_WORKER_ID) ||
        process.argv.some((arg) => arg.includes('jest'));
    const isTest = nodeEnv === 'test' || isJestRuntime;
    if (nodeEnv === 'production' && !isJestRuntime) {
        _env = validateEnv();
        return _env;
    }
    const parsed = envSchema.safeParse(process.env);
    if (parsed.success) {
        _env = {
            ...parsed.data,
            NODE_ENV: isTest ? 'test' : (parsed.data.NODE_ENV ?? 'development'),
            CORS_ORIGINS: parseOrigins(process.env.CORS_ORIGINS),
            PORT: Number(process.env.PORT ?? parsed.data.PORT ?? 3001),
        };
        return _env;
    }
    if (!hasWarnedNonProd) {
        console.warn('⚠️  Using relaxed environment defaults. Set required variables or run `npm run verify` before production deploys.');
        hasWarnedNonProd = true;
    }
    _env = buildFallbackEnv(isTest ? 'test' : 'development');
    return _env;
})();
// Getter function for compatibility
const getEnv = () => exports.env;
exports.getEnv = getEnv;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tvZmlydXN1L0Rlc2t0b3AvTmVvbkh1Yi9hcHBzL2FwaS9zcmMvY29uZmlnL2Vudi50cyIsIm1hcHBpbmdzIjoiOzs7QUFzREEsa0NBMkJDO0FBakZELDZCQUF3QjtBQUV4QixNQUFNLFNBQVMsR0FBRyxPQUFDLENBQUMsTUFBTSxDQUFDO0lBQ3pCLFdBQVc7SUFDWCxZQUFZLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxrQ0FBa0MsQ0FBQztJQUVoRSxtQkFBbUI7SUFDbkIsZUFBZSxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLGdEQUFnRCxDQUFDO0lBQ3JGLFlBQVksRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLGtDQUFrQyxDQUFDO0lBRWhFLE9BQU87SUFDUCxZQUFZLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsK0JBQStCLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUNqRixHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FDNUQ7SUFFRCxpQkFBaUI7SUFDakIsU0FBUyxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxRQUFRLEVBQUU7SUFFdEMsVUFBVTtJQUNWLGlCQUFpQixFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLCtCQUErQixDQUFDO0lBQ3JFLHFCQUFxQixFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLG1DQUFtQyxDQUFDO0lBRTdFLGdCQUFnQjtJQUNoQixjQUFjLEVBQUUsT0FBQyxDQUFDLE1BQU0s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LENBQUM7WUFDcEQsSUFBSSxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUM7U0FDM0QsQ0FBQztRQUNGLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVELElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQ3RCLE9BQU8sQ0FBQyxJQUFJLENBQ1YsbUhBQW1ILENBQ3BILENBQUM7UUFDRixnQkFBZ0IsR0FBRyxJQUFJLENBQUM7SUFDMUIsQ0FBQztJQUVELElBQUksR0FBRyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDekQsT0FBTyxJQUFJLENBQUM7QUFDZCxDQUFDLENBQUMsRUFBRSxDQUFDO0FBRUwsb0NBQW9DO0FBQzdCLE1BQU0sTUFBTSxHQUFHLEdBQUcsRUFBRSxDQUFDLFdBQUcsQ0FBQztBQUFuQixRQUFBLE1BQU0sVUFBYSIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMva29maXJ1c3UvRGVza3RvcC9OZW9uSHViL2FwcHMvYXBpL3NyYy9jb25maWcvZW52LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHogfSBmcm9tICd6b2QnO1xuXG5jb25zdCBlbnZTY2hlbWEgPSB6Lm9iamVjdCh7XG4gIC8vIERhdGFiYXNlXG4gIERBVEFCQVNFX1VSTDogei5zdHJpbmcoKS51cmwoJ0RBVEFCQVNFX1VSTCBtdXN0IGJlIGEgdmFsaWQgVVJMJyksXG4gIFxuICAvLyBBdXRoZW50aWNhdGlvbiAgXG4gIE5FWFRBVVRIX1NFQ1JFVDogei5zdHJpbmcoKS5taW4oMzIsICdORVhUQVVUSF9TRUNSRVQgbXVzdCBiZSBhdCBsZWFzdCAzMiBjaGFyYWN0ZXJzJyksXG4gIE5FWFRBVVRIX1VSTDogei5zdHJpbmcoKS51cmwoJ05FWFRBVVRIX1VSTCBtdXN0IGJlIGEgdmFsaWQgVVJMJyksXG4gIFxuICAvLyBDT1JTXG4gIENPUlNfT1JJR0lOUzogei5zdHJpbmcoKS5taW4oMSwgJ0NPUlNfT1JJR0lOUyBtdXN0IGJlIHByb3ZpZGVkJykudHJhbnNmb3JtKCh2YWwpID0+IFxuICAgIHZhbC5zcGxpdCgnLCcpLm1hcChvcmlnaW4gPT4gb3JpZ2luLnRyaW0oKSkuZmlsdGVyKEJvb2xlYW4pXG4gICksXG4gIFxuICAvLyBJbmZyYXN0cnVjdHVyZVxuICBSRURJU19VUkw6IHouc3RyaW5nKCkudXJsKCkub3B0aW9uYWwoKSxcbiAgXG4gIC8vIFBheW1lbnRcbiAgU1RSSVBFX1NFQ1JFVF9LRVk6IHouc3RyaW5nKCkubWluKDEsICdTVFJJUEVfU0VDUkVUX0tFWSBpcyByZXF1aXJlZCcpLFxuICBTVFJJUEVfV0VCSE9PS19TRUNSRVQ6IHouc3RyaW5nKCkubWluKDEsICdTVFJJUEVfV0VCSE9PS19TRUNSRVQgaXMgcmVxdWlyZWQnKSxcbiAgXG4gIC8vIEV4dGVybmFsIEFQSXNcbiAgUkVTRU5EX0FQSV9LRVk6IHouc3RyaW5nKCkubWluKDEsICdSRVNFTkRfQVBJX0tFWSBpcyByZXF1aXJlZCcpLFxuICBPUEVOQUlfQVBJX0tFWTogei5zdHJpbmcoKS5taW4oMSwgJ09QRU5BSV9BUElfS0VZIGlzIHJlcXVpcmVkJyksXG4gIE9QRU5BSV9NT0RFTDogei5zdHJpbmcoKS5kZWZhdWx0KCdncHQtNCcpLFxuICBcbiAgLy8gRW52aXJvbm1lbnRcbiAgTk9ERV9FTlY6IHouZW51bShbJ2RldmVsb3BtZW50JywgJ3Byb2R1Y3Rpb24nLCAndGVzdCddKS5kZWZhdWx0KCdkZXZlbG9wbWVudCcpLFxuICBQT1JUOiB6LmNvZXJjZS5udW1iZXIoKS5wb3NpdGl2ZSgpLmRlZmF1bHQoMzAwMSksXG4gIFxuICAvLyBCZXRhIFByb2dyYW1cbiAgQkVUQV9FTkFCTEVEOiB6LmNvZXJjZS5ib29sZWFuKCkuZGVmYXVsdChmYWxzZSksXG4gIFxuICAvLyBPcHRpb25hbCAtIE1vbml0b3JpbmdcbiAgU0VOVFJZX0RTTjogei5zdHJpbmcoKS51cmwoKS5vcHRpb25hbCgpLFxuICBcbiAgLy8gT3B0aW9uYWwgLSBTTVNcbiAgVFdJTElPX0FDQ09VTlRfU0lEOiB6LnN0cmluZygpLm9wdGlvbmFsKCksXG4gIFRXSUxJT19TSUQ6IHouc3RyaW5nKCkub3B0aW9uYWwoKSxcbiAgVFdJTElPX0FVVEhfVE9LRU46IHouc3RyaW5nKCkub3B0aW9uYWwoKSwgXG4gIFRXSUxJT19QSE9ORV9OVU1CRVI6IHouc3RyaW5nKCkub3B0aW9uYWwoKSxcbiAgXG4gIC8vIFNvY2lhbCBBUElzIChmb3IgdHJlbmRzIHNlcnZpY2UpXG4gIFRXSVRURVJfQkVBUkVSX1RPS0VOOiB6LnN0cmluZygpLm9wdGlvbmFsKCksXG4gIFJFRERJVF9DTElFTlRfSUQ6IHouc3RyaW5nKCkub3B0aW9uYWwoKSxcbiAgUkVERElUX0NMSUVOVF9TRUNSRVQ6IHouc3RyaW5nKCkub3B0aW9uYWwoKSxcbiAgUkVERElUX1VTRVJfQUdFTlQ6IHouc3RyaW5nKCkuZGVmYXVsdCgnTmVvbkh1Yi8zLjInKSxcbn0pO1xuXG5leHBvcnQgdHlwZSBFbnYgPSB6LmluZmVyPHR5cGVvZiBlbnZTY2hlbWE+O1xuXG5sZXQgaGFzV2FybmVkTm9uUHJvZCA9IGZhbHNlO1xuXG5leHBvcnQgZnVuY3Rpb24gdmFsaWRhdGVFbnYoKTogRW52IHtcbiAgdHJ5IHtcbiAgICByZXR1cm4gZW52U2NoZW1hLnBhcnNlKHByb2Nlc3MuZW52KTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiB6LlpvZEVycm9yKSB7XG4gICAgICBjb25zdCBtaXNzaW5nVmFycyA9IGVycm9yLmVycm9ycy5tYXAoZXJyID0+IGAke2Vyci5wYXRoLmpvaW4oJy4nKX06ICR7ZXJyLm1lc3NhZ2V9YCkuam9pbignXFxuJyk7XG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRW52aXJvbm1lbnQgdmFsaWRhdGlvbiBmYWlsZWQ6XFxuJyArIG1pc3NpbmdWYXJzKTtcblxuICAgICAgY29uc3Qgbm9kZUVudiA9IChwcm9jZXNzLmVudi5OT0RFX0VOViA/PyAnZGV2ZWxvcG1lbnQnKS50b0xvd2VyQ2FzZSgpO1xuICAgICAgY29uc3QgaXNKZXN0UnVudGltZSA9XG4gICAgICAgIEJvb2xlYW4ocHJvY2Vzcy5lbnYuSkVTVF9XT1JLRVJfSUQpIHx8XG4gICAgICAgIHByb2Nlc3MuYXJndi5zb21lKChhcmcpID0+IGFyZy5pbmNsdWRlcygnamVzdCcpKTtcblxuICAgICAgaWYgKG5vZGVFbnYgIT09ICdwcm9kdWN0aW9uJyB8fCBpc0plc3RSdW50aW1lKSB7XG4gICAgICAgIGlmICghaGFzV2FybmVkTm9uUHJvZCkge1xuICAgICAgICAgIGNvbnNvbGUud2FybihcbiAgICAgICAgICAgICfimqDvuI8gIFVzaW5nIHJlbGF4ZWQgZW52aXJvbm1lbnQgZGVmYXVsdHMuIFNldCByZXF1aXJlZCB2YXJpYWJsZXMgb3IgcnVuIGBucG0gcnVuIHZlcmlmeWAgYmVmb3JlIHByb2R1Y3Rpb24gZGVwbG95cy4nXG4gICAgICAgICAgKTtcbiAgICAgICAgICBoYXNXYXJuZWROb25Qcm9kID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gYnVpbGRGYWxsYmFja0Vudihub2RlRW52ID09PSAndGVzdCcgfHwgaXNKZXN0UnVudGltZSA/ICd0ZXN0JyA6ICdkZXZlbG9wbWVudCcpO1xuICAgICAgfVxuXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEVudmlyb25tZW50IHZhbGlkYXRpb24gZmFpbGVkOlxcbiR7bWlzc2luZ1ZhcnN9YCk7XG4gICAgfVxuICAgIHRocm93IGVycm9yO1xuICB9XG59XG5cbi8vIFNpbmdsZXRvbiBpbnN0YW5jZSAtIHNraXAgc3RyaWN0IHZhbGlkYXRpb24gaW4gdGVzdCBtb2RlXG5sZXQgX2VudjogRW52IHwgbnVsbCA9IG51bGw7XG5cbmZ1bmN0aW9uIHBhcnNlT3JpZ2lucyhyYXc/OiBzdHJpbmcgfCBzdHJpbmdbXSk6IHN0cmluZ1tdIHtcbiAgaWYgKEFycmF5LmlzQXJyYXkocmF3KSkge1xuICAgIHJldHVybiByYXc7XG4gIH1cbiAgaWYgKCFyYXcpIHtcbiAgICByZXR1cm4gWydodHRwOi8vbG9jYWxob3N0OjMwMDAnXTtcbiAgfVxuICByZXR1cm4gcmF3XG4gICAgLnNwbGl0KCcsJylcbiAgICAubWFwKChvcmlnaW4pID0+IG9yaWdpbi50cmltKCkpXG4gICAgLmZpbHRlcihCb29sZWFuKTtcbn1cblxuZnVuY3Rpb24gYnVpbGRGYWxsYmFja0Vudih0YXJnZXQ6ICd0ZXN0JyB8ICdkZXZlbG9wbWVudCcpOiBFbnYge1xuICBjb25zdCBkZWZhdWx0cyA9IHtcbiAgICBEQVRBQkFTRV9VUkw6XG4gICAgICBwcm9jZXNzLmVudi5EQVRBQkFTRV9VUkwgfHxcbiAgICAgICh0YXJnZXQgPT09ICd0ZXN0J1xuICAgICAgICA/ICdwb3N0Z3Jlc3FsOi8vdGVzdDp0ZXN0QGxvY2FsaG9zdDo1NDMyL3Rlc3QnXG4gICAgICAgIDogJ3Bvc3RncmVzcWw6Ly9sb2NhbGhvc3Q6NTQzMi9uZW9uaHViJyksXG4gICAgTkVYVEFVVEhfU0VDUkVUOlxuICAgICAgcHJvY2Vzcy5lbnYuTkVYVEFVVEhfU0VDUkVUIHx8XG4gICAgICAodGFyZ2V0ID09PSAndGVzdCdcbiAgICAgICAgPyAndGVzdC1zZWNyZXQtbWluLTMyLWNoYXJzLWxvbmctMTIzNDUnXG4gICAgICAgIDogJ2Rldi1zZWNyZXQtbWluLTMyLWNoYXJzLWxvbmctMTIzNDUnKSxcbiAgICBORVhUQVVUSF9VUkw6IHByb2Nlc3MuZW52Lk5FWFRBVVRIX1VSTCB8fCAnaHR0cDovL2xvY2FsaG9zdDozMDAwJyxcbiAgICBDT1JTX09SSUdJTlM6IHBhcnNlT3JpZ2lucyhwcm9jZXNzLmVudi5DT1JTX09SSUdJTlMpLFxuICAgIFJFRElTX1VSTDogcHJvY2Vzcy5lbnYuUkVESVNfVVJMIHx8ICdyZWRpczovL2xvY2FsaG9zdDo2Mzc5JyxcbiAgICBTVFJJUEVfU0VDUkVUX0tFWTpcbiAgICAgIHByb2Nlc3MuZW52LlNUUklQRV9TRUNSRVRfS0VZIHx8XG4gICAgICAodGFyZ2V0ID09PSAndGVzdCcgPyAnc2tfdGVzdF9mYWtlJyA6ICdza190ZXN0X2RldicpLFxuICAgIFNUUklQRV9XRUJIT09LX1NFQ1JFVDpcbiAgICAgIHByb2Nlc3MuZW52LlNUUklQRV9XRUJIT09LX1NFQ1JFVCB8fFxuICAgICAgKHRhcmdldCA9PT0gJ3Rlc3QnID8gJ3doc2VjX3Rlc3RfZmFrZScgOiAnd2hzZWNfZGV2X2Zha2UnKSxcbiAgICBSRVNFTkRfQVBJX0tFWTogcHJvY2Vzcy5lbnYuUkVTRU5EX0FQSV9LRVkgfHwgJ3Rlc3RfZmFrZScsXG4gICAgT1BFTkFJX0FQSV9LRVk6XG4gICAgICBwcm9jZXNzLmVudi5PUEVOQUlfQVBJX0tFWSB8fFxuICAgICAgKHRhcmdldCA9PT0gJ3Rlc3QnXG4gICAgICAgID8gJ3Rlc3Qta2V5LWZvci10ZXN0aW5nJ1xuICAgICAgICA6ICd0ZXN0LWtleS1mb3ItZGV2ZWxvcG1lbnQnKSxcbiAgICBPUEVOQUlfTU9ERUw6IHByb2Nlc3MuZW52Lk9QRU5BSV9NT0RFTCB8fCAnZ3B0LTQnLFxuICAgIE5PREVfRU5WOiB0YXJnZXQgYXMgJ3Rlc3QnIHwgJ2RldmVsb3BtZW50JyB8ICdwcm9kdWN0aW9uJyxcbiAgICBQT1JUOiBOdW1iZXIocHJvY2Vzcy5lbnYuUE9SVCA/PyAzMDAxKSxcbiAgICBTRU5UUllfRFNOOiBwcm9jZXNzLmVudi5TRU5UUllfRFNOLFxuICAgIFRXSUxJT19BQ0NPVU5UX1NJRDogcHJvY2Vzcy5lbnYuVFdJTElPX0FDQ09VTlRfU0lELFxuICAgIFRXSUxJT19TSUQ6IHByb2Nlc3MuZW52LlRXSUxJT19TSUQgfHwgcHJvY2Vzcy5lbnYuVFdJTElPX0FDQ09VTlRfU0lELFxuICAgIFRXSUxJT19BVVRIX1RPS0VOOiBwcm9jZXNzLmVudi5UV0lMSU9fQVVUSF9UT0tFTixcbiAgICBUV0lMSU9fUEhPTkVfTlVNQkVSOiBwcm9jZXNzLmVudi5UV0lMSU9fUEhPTkVfTlVNQkVSLFxuICB9O1xuXG4gIHJldHVybiBkZWZhdWx0cztcbn1cblxuZXhwb3J0IGNvbnN0IGVudiA9ICgoKSA9PiB7XG4gIGlmIChfZW52KSByZXR1cm4gX2VudjtcbiAgXG4gIGNvbnN0IG5vZGVFbnYgPSAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgPz8gJ2RldmVsb3BtZW50JykudG9Mb3dlckNhc2UoKTtcbiAgY29uc3QgaXNKZXN0UnVudGltZSA9XG4gICAgQm9vbGVhbihwcm9jZXNzLmVudi5KRVNUX1dPUktFUl9JRCkgfHxcbiAgICBwcm9jZXNzLmFyZ3Yuc29tZSgoYXJnKSA9PiBhcmcuaW5jbHVkZXMoJ2plc3QnKSk7XG4gIGNvbnN0IGlzVGVzdCA9IG5vZGVFbnYgPT09ICd0ZXN0JyB8fCBpc0plc3RSdW50aW1lO1xuXG4gIGlmIChub2RlRW52ID09PSAncHJvZHVjdGlvbicgJiYgIWlzSmVzdFJ1bnRpbWUpIHtcbiAgICBfZW52ID0gdmFsaWRhdGVFbnYoKTtcbiAgICByZXR1cm4gX2VudjtcbiAgfVxuXG4gIGNvbnN0IHBhcnNlZCA9IGVudlNjaGVtYS5zYWZlUGFyc2UocHJvY2Vzcy5lbnYpO1xuICBpZiAocGFyc2VkLnN1Y2Nlc3MpIHtcbiAgICBfZW52ID0ge1xuICAgICAgLi4ucGFyc2VkLmRhdGEsXG4gICAgICBOT0RFX0VOVjogaXNUZXN0ID8gJ3Rlc3QnIDogKHBhcnNlZC5kYXRhLk5PREVfRU5WID8/ICdkZXZlbG9wbWVudCcpLFxuICAgICAgQ09SU19PUklHSU5TOiBwYXJzZU9yaWdpbnMocHJvY2Vzcy5lbnYuQ09SU19PUklHSU5TKSxcbiAgICAgIFBPUlQ6IE51bWJlcihwcm9jZXNzLmVudi5QT1JUID8/IHBhcnNlZC5kYXRhLlBPUlQgPz8gMzAwMSksXG4gICAgfTtcbiAgICByZXR1cm4gX2VudjtcbiAgfVxuXG4gIGlmICghaGFzV2FybmVkTm9uUHJvZCkge1xuICAgIGNvbnNvbGUud2FybihcbiAgICAgICfimqDvuI8gIFVzaW5nIHJlbGF4ZWQgZW52aXJvbm1lbnQgZGVmYXVsdHMuIFNldCByZXF1aXJlZCB2YXJpYWJsZXMgb3IgcnVuIGBucG0gcnVuIHZlcmlmeWAgYmVmb3JlIHByb2R1Y3Rpb24gZGVwbG95cy4nXG4gICAgKTtcbiAgICBoYXNXYXJuZWROb25Qcm9kID0gdHJ1ZTtcbiAgfVxuXG4gIF9lbnYgPSBidWlsZEZhbGxiYWNrRW52KGlzVGVzdCA/ICd0ZXN0JyA6ICdkZXZlbG9wbWVudCcpO1xuICByZXR1cm4gX2Vudjtcbn0pKCk7XG5cbi8vIEdldHRlciBmdW5jdGlvbiBmb3IgY29tcGF0aWJpbGl0eVxuZXhwb3J0IGNvbnN0IGdldEVudiA9ICgpID0+IGVudjtcbiJdLCJ2ZXJzaW9uIjozfQ==