31351900f19e4e053312276ceae7bebd
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const globals_1 = require("@jest/globals");
globals_1.jest.mock("googleapis", () => {
    const insertMock = globals_1.jest.fn();
    const updateMock = globals_1.jest.fn();
    const listMock = globals_1.jest.fn();
    const youtubeMock = {
        videos: {
            insert: insertMock,
            update: updateMock,
            list: listMock,
        },
    };
    const authMock = {
        OAuth2: globals_1.jest.fn().mockImplementation(() => ({
            setCredentials: globals_1.jest.fn(),
        })),
    };
    const googleMock = {
        auth: authMock,
        youtube: globals_1.jest.fn().mockImplementation(() => youtubeMock),
    };
    return { google: googleMock, __esModule: true };
});
globals_1.jest.mock("node:fs", () => ({
    createReadStream: globals_1.jest.fn(() => new node_stream_1.PassThrough()),
}));
const node_stream_1 = require("node:stream");
const googleapis_1 = require("googleapis");
const YouTubeConnector_js_1 = require("../services/YouTubeConnector.js");
const RetryManager_js_1 = require("../execution/RetryManager.js");
const connector = new YouTubeConnector_js_1.YouTubeConnector();
const runSpy = globals_1.jest.spyOn(RetryManager_js_1.retryManager, "run");
const auth = {
    accessToken: "ya29.test",
    metadata: {
        refreshToken: "refresh-token",
        clientId: "client-id",
        clientSecret: "client-secret",
        channelId: "channel-id",
    },
};
(0, globals_1.beforeEach)(() => {
    googleapis_1.google.youtube.mockClear();
    runSpy.mockImplementation(async (fn) => fn());
});
(0, globals_1.afterAll)(() => {
    runSpy.mockRestore();
});
(0, globals_1.describe)("YouTubeConnector", () => {
    (0, globals_1.it)("uploads videos", async () => {
        const action = connector.actions.find(a => a.id === "uploadVideo");
        if (!action)
            throw new Error("uploadVideo not found");
        const insertMock = globals_1.jest.fn().mockImplementation(async () => ({ data: { id: "yt_upload_123", etag: "etag" } }));
        googleapis_1.google.youtube.mockReturnValueOnce({
            videos: {
                insert: insertMock,
            },
        });
        const result = await action.execute({
            auth,
            input: {
                title: "Launch Day",
                description: "Highlights",
                videoFile: "./fixtures/video.mp4",
                privacyStatus: "public",
            },
        });
        (0, globals_1.expect)(result).toEqual({ videoId: "yt_upload_123", etag: "etag" });
        (0, globals_1.expect)(insertMock).toHaveBeenCalled();
    });
    (0, globals_1.it)("updates videos", async () => {
        const action = connector.actions.find(a => a.id === "updateVideo");
        if (!action)
            throw new Error("updateVideo not found");
        const updateMock = globals_1.jest.fn().mockImplementation(async () => ({ data: { id: "yt_video_456" } }));
        googleapis_1.google.youtube.mockReturnValueOnce({
            videos: {
                update: updateMock,
            },
        });
        const result = await action.execute({
            auth,
            input: {
                videoId: "yt_video_456",
                title: "New Title",
            },
        });
        (0, globals_1.expect)(result).toEqual({ id: "yt_video_456" });
        (0, globals_1.expect)(updateMock).toHaveBeenCalled();
    });
    (0, globals_1.it)("retrieves video stats", async () => {
        const action = connector.actions.find(a => a.id === "getVideoStats");
        if (!action)
            throw new Error("getVideoStats not found");
        const listMock = globals_1.jest.fn().mockImplementation(async () => ({
            data: {
                items: [
                    {
                        statistics: {
                            viewCount: "1024",
                            likeCount: "512",
                            commentCount: "12",
                        },
                    },
                ],
            },
        }));
        googleapis_1.google.youtube.mockReturnValueOnce({
            videos: {
                list: listMock,
            },
        });
        const result = await action.execute({
            auth,
            input: { videoId: "yt_video_789" },
        });
        (0, globals_1.expect)(result).toEqual({ views: 1024, likes: 512, comments: 12 });
        (0, globals_1.expect)(listMock).toHaveBeenCalled();
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tvZmlydXN1L0Rlc2t0b3AvTmVvbkh1Yi9hcHBzL2FwaS9zcmMvY29ubmVjdG9ycy9fX3Rlc3RzX18veW91dHViZS1jb25uZWN0b3IudGVzdC50cyIsIm1hcHBpbmdzIjoiOztBQUFBLDJDQUFpRjtBQU9qRixjQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxHQUFHLEVBQUU7SUFDM0IsTUFBTSxVQUFVLEdBQUcsY0FBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO0lBQzdCLE1BQU0sVUFBVSxHQUFHLGNBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztJQUM3QixNQUFNLFFBQVEsR0FBRyxjQUFJLENBQUMsRUFBRSxFQUFFLENBQUM7SUFFM0IsTUFBTSxXQUFXLEdBQUc7UUFDbEIsTUFBTSxFQUFFO1lBQ04sTUFBTSxFQUFFLFVBQVU7WUFDbEIsTUFBTSxFQUFFLFVBQVU7WUFDbEIsSUFBSSxFQUFFLFFBQVE7U0FDZjtLQUNTLENBQUM7SUFFYixNQUFNLFFBQVEsR0FBRztRQUNmLE1BQU0sRUFBRSxjQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsa0JBQWtCLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztZQUMxQyxjQUFjLEVBQUUsY0FBSSxDQUFDLEVBQUUsRUFBRTtTQUMxQixDQUFDLENBQUM7S0FDSixDQUFDO0lBRUYsTUFBTSxVQUFVLEdBQUc7UUFDakIsSUFBSSxFQUFFLFFBQVE7UUFDZCxPQUFPLEVBQUUsY0FBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGtCQUFrQixDQUFDLEdBQUcsRUFBRSxDQUFDLFdBQVcsQ0FBQztLQUN6RCxDQUFDO0lBRUYsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsVUFBVSxFQUFFLElBQUksRUFBRSxDQUFDO0FBQ2xELENBQUMsQ0FBQyxDQUFDO0FBRUgsY0FBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztJQUMxQixnQkFBZ0IsRUFBRSxjQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLElB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O1FBQ1YsbUJBQU0sQ0FBQyxPQUFxQixDQUFDLG1CQUFtQixDQUFDO1lBQ2hELE1BQU0sRUFBRTtnQkFDTixJQUFJLEVBQUUsUUFBUTthQUNmO1NBQ0ssQ0FBQyxDQUFDO1FBRVYsTUFBTSxNQUFNLEdBQUcsTUFBTSxNQUFNLENBQUMsT0FBTyxDQUFDO1lBQ2xDLElBQUk7WUFDSixLQUFLLEVBQUUsRUFBRSxPQUFPLEVBQUUsY0FBYyxFQUFFO1NBQ25DLENBQUMsQ0FBQztRQUVILElBQUEsZ0JBQU0sRUFBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsUUFBUSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDbEUsSUFBQSxnQkFBTSxFQUFDLFFBQVEsQ0FBQyxDQUFDLGdCQUFnQixFQUFFLENBQUM7SUFDdEMsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMva29maXJ1c3UvRGVza3RvcC9OZW9uSHViL2FwcHMvYXBpL3NyYy9jb25uZWN0b3JzL19fdGVzdHNfXy95b3V0dWJlLWNvbm5lY3Rvci50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGRlc2NyaWJlLCBpdCwgZXhwZWN0LCBiZWZvcmVFYWNoLCBqZXN0LCBhZnRlckFsbCB9IGZyb20gXCJAamVzdC9nbG9iYWxzXCI7XG5pbXBvcnQgZnMgZnJvbSBcIm5vZGU6ZnNcIjtcbmltcG9ydCB7IFBhc3NUaHJvdWdoIH0gZnJvbSBcIm5vZGU6c3RyZWFtXCI7XG5pbXBvcnQgeyBnb29nbGUgfSBmcm9tIFwiZ29vZ2xlYXBpc1wiO1xuaW1wb3J0IHsgWW91VHViZUNvbm5lY3RvciB9IGZyb20gXCIuLi9zZXJ2aWNlcy9Zb3VUdWJlQ29ubmVjdG9yLmpzXCI7XG5pbXBvcnQgeyByZXRyeU1hbmFnZXIgfSBmcm9tIFwiLi4vZXhlY3V0aW9uL1JldHJ5TWFuYWdlci5qc1wiO1xuXG5qZXN0Lm1vY2soXCJnb29nbGVhcGlzXCIsICgpID0+IHtcbiAgY29uc3QgaW5zZXJ0TW9jayA9IGplc3QuZm4oKTtcbiAgY29uc3QgdXBkYXRlTW9jayA9IGplc3QuZm4oKTtcbiAgY29uc3QgbGlzdE1vY2sgPSBqZXN0LmZuKCk7XG5cbiAgY29uc3QgeW91dHViZU1vY2sgPSB7XG4gICAgdmlkZW9zOiB7XG4gICAgICBpbnNlcnQ6IGluc2VydE1vY2ssXG4gICAgICB1cGRhdGU6IHVwZGF0ZU1vY2ssXG4gICAgICBsaXN0OiBsaXN0TW9jayxcbiAgICB9LFxuICB9IGFzIHVua25vd247XG5cbiAgY29uc3QgYXV0aE1vY2sgPSB7XG4gICAgT0F1dGgyOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+ICh7XG4gICAgICBzZXRDcmVkZW50aWFsczogamVzdC5mbigpLFxuICAgIH0pKSxcbiAgfTtcblxuICBjb25zdCBnb29nbGVNb2NrID0ge1xuICAgIGF1dGg6IGF1dGhNb2NrLFxuICAgIHlvdXR1YmU6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4geW91dHViZU1vY2spLFxuICB9O1xuXG4gIHJldHVybiB7IGdvb2dsZTogZ29vZ2xlTW9jaywgX19lc01vZHVsZTogdHJ1ZSB9O1xufSk7XG5cbmplc3QubW9jayhcIm5vZGU6ZnNcIiwgKCkgPT4gKHtcbiAgY3JlYXRlUmVhZFN0cmVhbTogamVzdC5mbigoKSA9PiBuZXcgUGFzc1Rocm91Z2goKSksXG59KSk7XG5cbmNvbnN0IGNvbm5lY3RvciA9IG5ldyBZb3VUdWJlQ29ubmVjdG9yKCk7XG5jb25zdCBydW5TcHkgPSBqZXN0LnNweU9uKHJldHJ5TWFuYWdlciwgXCJydW5cIik7XG5jb25zdCBhdXRoID0ge1xuICBhY2Nlc3NUb2tlbjogXCJ5YTI5LnRlc3RcIixcbiAgbWV0YWRhdGE6IHtcbiAgICByZWZyZXNoVG9rZW46IFwicmVmcmVzaC10b2tlblwiLFxuICAgIGNsaWVudElkOiBcImNsaWVudC1pZFwiLFxuICAgIGNsaWVudFNlY3JldDogXCJjbGllbnQtc2VjcmV0XCIsXG4gICAgY2hhbm5lbElkOiBcImNoYW5uZWwtaWRcIixcbiAgfSxcbn07XG5cbmJlZm9yZUVhY2goKCkgPT4ge1xuICAoZ29vZ2xlLnlvdXR1YmUgYXMgamVzdC5Nb2NrKS5tb2NrQ2xlYXIoKTtcbiAgcnVuU3B5Lm1vY2tJbXBsZW1lbnRhdGlvbihhc3luYyBmbiA9PiBmbigpKTtcbn0pO1xuXG5hZnRlckFsbCgoKSA9PiB7XG4gIHJ1blNweS5tb2NrUmVzdG9yZSgpO1xufSk7XG5cbmRlc2NyaWJlKFwiWW91VHViZUNvbm5lY3RvclwiLCAoKSA9PiB7XG4gIGl0KFwidXBsb2FkcyB2aWRlb3NcIiwgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGFjdGlvbiA9IGNvbm5lY3Rvci5hY3Rpb25zLmZpbmQoYSA9PiBhLmlkID09PSBcInVwbG9hZFZpZGVvXCIpO1xuICAgIGlmICghYWN0aW9uKSB0aHJvdyBuZXcgRXJyb3IoXCJ1cGxvYWRWaWRlbyBub3QgZm91bmRcIik7XG5cbiAgICBjb25zdCBpbnNlcnRNb2NrID0gamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbihhc3luYyAoKSA9PiAoeyBkYXRhOiB7IGlkOiBcInl0X3VwbG9hZF8xMjNcIiwgZXRhZzogXCJldGFnXCIgfSB9IGFzIGFueSkpO1xuICAgIChnb29nbGUueW91dHViZSBhcyBqZXN0Lk1vY2spLm1vY2tSZXR1cm5WYWx1ZU9uY2Uoe1xuICAgICAgdmlkZW9zOiB7XG4gICAgICAgIGluc2VydDogaW5zZXJ0TW9jayxcbiAgICAgIH0sXG4gICAgfSBhcyBhbnkpO1xuXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgYWN0aW9uLmV4ZWN1dGUoe1xuICAgICAgYXV0aCxcbiAgICAgIGlucHV0OiB7XG4gICAgICAgIHRpdGxlOiBcIkxhdW5jaCBEYXlcIixcbiAgICAgICAgZGVzY3JpcHRpb246IFwiSGlnaGxpZ2h0c1wiLFxuICAgICAgICB2aWRlb0ZpbGU6IFwiLi9maXh0dXJlcy92aWRlby5tcDRcIixcbiAgICAgICAgcHJpdmFjeVN0YXR1czogXCJwdWJsaWNcIixcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKHsgdmlkZW9JZDogXCJ5dF91cGxvYWRfMTIzXCIsIGV0YWc6IFwiZXRhZ1wiIH0pO1xuICAgIGV4cGVjdChpbnNlcnRNb2NrKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gIH0pO1xuXG4gIGl0KFwidXBkYXRlcyB2aWRlb3NcIiwgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGFjdGlvbiA9IGNvbm5lY3Rvci5hY3Rpb25zLmZpbmQoYSA9PiBhLmlkID09PSBcInVwZGF0ZVZpZGVvXCIpO1xuICAgIGlmICghYWN0aW9uKSB0aHJvdyBuZXcgRXJyb3IoXCJ1cGRhdGVWaWRlbyBub3QgZm91bmRcIik7XG5cbiAgICBjb25zdCB1cGRhdGVNb2NrID0gamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbihhc3luYyAoKSA9PiAoeyBkYXRhOiB7IGlkOiBcInl0X3ZpZGVvXzQ1NlwiIH0gfSBhcyBhbnkpKTtcbiAgICAoZ29vZ2xlLnlvdXR1YmUgYXMgamVzdC5Nb2NrKS5tb2NrUmV0dXJuVmFsdWVPbmNlKHtcbiAgICAgIHZpZGVvczoge1xuICAgICAgICB1cGRhdGU6IHVwZGF0ZU1vY2ssXG4gICAgICB9LFxuICAgIH0gYXMgYW55KTtcblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGFjdGlvbi5leGVjdXRlKHtcbiAgICAgIGF1dGgsXG4gICAgICBpbnB1dDoge1xuICAgICAgICB2aWRlb0lkOiBcInl0X3ZpZGVvXzQ1NlwiLFxuICAgICAgICB0aXRsZTogXCJOZXcgVGl0bGVcIixcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKHsgaWQ6IFwieXRfdmlkZW9fNDU2XCIgfSk7XG4gICAgZXhwZWN0KHVwZGF0ZU1vY2spLnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgfSk7XG5cbiAgaXQoXCJyZXRyaWV2ZXMgdmlkZW8gc3RhdHNcIiwgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGFjdGlvbiA9IGNvbm5lY3Rvci5hY3Rpb25zLmZpbmQoYSA9PiBhLmlkID09PSBcImdldFZpZGVvU3RhdHNcIik7XG4gICAgaWYgKCFhY3Rpb24pIHRocm93IG5ldyBFcnJvcihcImdldFZpZGVvU3RhdHMgbm90IGZvdW5kXCIpO1xuXG4gICAgY29uc3QgbGlzdE1vY2sgPSBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKGFzeW5jICgpID0+ICh7XG4gICAgICBkYXRhOiB7XG4gICAgICAgIGl0ZW1zOiBbXG4gICAgICAgICAge1xuICAgICAgICAgICAgc3RhdGlzdGljczoge1xuICAgICAgICAgICAgICB2aWV3Q291bnQ6IFwiMTAyNFwiLFxuICAgICAgICAgICAgICBsaWtlQ291bnQ6IFwiNTEyXCIsXG4gICAgICAgICAgICAgIGNvbW1lbnRDb3VudDogXCIxMlwiLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICBdLFxuICAgICAgfSxcbiAgICB9IGFzIGFueSkpO1xuICAgIChnb29nbGUueW91dHViZSBhcyBqZXN0Lk1vY2spLm1vY2tSZXR1cm5WYWx1ZU9uY2Uoe1xuICAgICAgdmlkZW9zOiB7XG4gICAgICAgIGxpc3Q6IGxpc3RNb2NrLFxuICAgICAgfSxcbiAgICB9IGFzIGFueSk7XG5cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBhY3Rpb24uZXhlY3V0ZSh7XG4gICAgICBhdXRoLFxuICAgICAgaW5wdXQ6IHsgdmlkZW9JZDogXCJ5dF92aWRlb183ODlcIiB9LFxuICAgIH0pO1xuXG4gICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbCh7IHZpZXdzOiAxMDI0LCBsaWtlczogNTEyLCBjb21tZW50czogMTIgfSk7XG4gICAgZXhwZWN0KGxpc3RNb2NrKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=